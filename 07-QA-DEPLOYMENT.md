# QA & Deployment Specification: Foundry
**Generated by:** Agent 7 - QA & Deployment v25 (Application-Agnostic)  
**Date:** 2026-01-21  
**Status:** Complete  
**Framework Version:** Agent Specification Framework v2.1  
**Constitution:** Agent 0 - Agent Constitution v3.3

---

## Document Purpose

This QA & Deployment specification defines test requirements and deployment procedures for Foundry. Every specification item receives corresponding test requirements. Every deployment step documented for first-time success. This document specifies WHAT to test and WHAT to verify—not test implementations.

---

## 1. Input Analysis Summary

### 1.1 Specification Inventory

| Source Document | Key Metrics | Status |
|-----------------|-------------|--------|
| PRD (01-PRD.md) | 38 user stories, 4 personas | ✓ Complete |
| Architecture (02-ARCHITECTURE.md) | Monolithic full-stack, Replit deployment | ✓ Complete |
| Data Model (03-DATA-MODEL.md) | 10 database tables, multi-tenant | ✓ Complete |
| API Contract (04-API-CONTRACT.md) | 43 endpoints, 8 categories | ✓ Complete |
| UI/UX (05-UI-UX-SPECIFICATION.md) | 21 pages, 6 phases | ✓ Complete |
| Implementation (06-IMPLEMENTATION-PLAN.md) | 87 tasks, 8-12 weeks | ✓ Complete |

### 1.2 Test Coverage Targets

| Category | Total Count | Coverage Target |
|----------|-------------|-----------------|
| User Stories | 38 | 100% (all acceptance criteria) |
| API Endpoints | 43 | 100% (all endpoints, all response codes) |
| UI Pages | 21 | 100% (all pages, all states) |
| Data Tables | 10 | 100% (all constraints, relationships) |
| Forms | 15 | 100% (all fields, all validation rules) |

### 1.3 Technology Stack

**Frontend:**
- React 18 + TypeScript
- Vite build tool
- shadcn/ui + Tailwind CSS v4
- TanStack Query (React Query)

**Backend:**
- Express.js + TypeScript
- PostgreSQL 14+ with Drizzle ORM
- postgres-js driver
- JWT authentication (HS256, 24h expiry)

**External Services:**
- S3-compatible storage (Cloudflare R2 recommended)
- Resend (email service)
- Teamwork Desk (OAuth integration)

**Deployment:**
- Replit platform
- Port 5000
- Single container
- Ephemeral filesystem

---

## 2. Test Strategy

### 2.1 Test Layers

| Layer | Purpose | Recommended Tools | Coverage Target |
|-------|---------|-------------------|-----------------|
| Unit | Isolated function testing | Vitest | Core utilities, validators |
| Integration | API endpoint testing | Supertest + Vitest | 100% of 43 endpoints |
| Component | UI component testing | Testing Library + Vitest | Critical components |
| E2E | User flow testing | Playwright | Happy paths + critical flows |

### 2.2 Test Execution Strategy

**Pre-Commit:**
- TypeScript compilation
- ESLint checks
- Unit tests (fast)

**CI Pipeline:**
- All unit tests
- All integration tests
- Component tests
- E2E smoke tests

**Pre-Deployment:**
- Full E2E test suite
- Manual QA checklist
- Production verification gates

### 2.3 Test Data Requirements

**Test Users:**

| Role | Email | Password | Purpose |
|------|-------|----------|---------|
| Admin | admin@test.foundry.dev | AdminTest123! | Admin feature testing |
| Editor | editor@test.foundry.dev | EditorTest123! | Editor feature testing |
| Viewer | viewer@test.foundry.dev | ViewerTest123! | Viewer role testing |

**Test Organization:**
- Name: "Test Organization"
- Slug: "test-org"
- Created at: Fixed timestamp for reproducibility

**Test Project:**
- Name: "Test Project"
- Description: "Project for automated testing"
- Owner: Admin user

**Test Data Files:**
- CSV: 100 rows, conversation schema
- JSON: Nested structure, 50 records
- XLSX: Multiple sheets, 200 rows

---

## 3. User Story Test Requirements

### 3.1 Authentication Stories

#### TR-001: User Registration
- **Traces to**: US-1 (Register account)
- **Type**: Integration + E2E
- **Component Under Test**: POST /api/auth/register, RegisterPage
- **Preconditions**: No existing account with test email
- **Test Input**: Valid registration form (email, password, name)
- **Expected Result**: 201 Created, JWT token returned, user auto-logged in
- **Verification Points**:
  - [ ] User created in database with hashed password
  - [ ] Organization created with user as admin
  - [ ] JWT token contains correct payload (userId, email, organisationId, role)
  - [ ] User redirected to /dashboard
  - [ ] Password meets complexity requirements (min 8, 1 uppercase, 1 digit)

#### TR-002: User Registration Validation
- **Traces to**: US-1 (Register account validation)
- **Type**: Integration
- **Component Under Test**: POST /api/auth/register
- **Test Scenarios**:

| Scenario | Input | Expected Status | Expected Response |
|----------|-------|-----------------|-------------------|
| Duplicate email | Existing email | 409 | DUPLICATE_EMAIL |
| Invalid email | "not-an-email" | 400 | VALIDATION_ERROR |
| Weak password | "short" | 400 | VALIDATION_ERROR |
| Missing name | Empty name | 400 | VALIDATION_ERROR |
| Invalid invite token | Bad UUID | 410 | INVALID_TOKEN |

#### TR-003: User Login
- **Traces to**: US-2 (Login)
- **Type**: Integration + E2E
- **Component Under Test**: POST /api/auth/login, LoginPage
- **Preconditions**: User account exists
- **Test Input**: Valid credentials (email, password)
- **Expected Result**: 200 OK, JWT token returned
- **Verification Points**:
  - [ ] JWT token contains correct user data
  - [ ] lastLoginAt timestamp updated in database
  - [ ] User redirected to /dashboard
  - [ ] Token stored in localStorage
  - [ ] Rate limiting headers present (X-RateLimit-*)

#### TR-004: User Login Failures
- **Traces to**: US-2 (Login error handling)
- **Type**: Integration
- **Component Under Test**: POST /api/auth/login
- **Test Scenarios**:

| Scenario | Input | Expected Status | Expected Response |
|----------|-------|-----------------|-------------------|
| Wrong password | Invalid password | 401 | INVALID_CREDENTIALS |
| Non-existent email | Unknown email | 401 | INVALID_CREDENTIALS |
| Rate limit exceeded | 6 requests in 15min | 429 | RATE_LIMIT_EXCEEDED |

#### TR-005: Password Reset Flow
- **Traces to**: US-3, US-4 (Forgot password, Reset password)
- **Type**: Integration + E2E
- **Component Under Test**: POST /api/auth/forgot-password, POST /api/auth/reset-password
- **Test Flow**:
  1. Request password reset (email sent)
  2. Validate reset token (GET /api/auth/reset-password/:token)
  3. Submit new password
  4. Login with new password
- **Verification Points**:
  - [ ] Email sent with reset link (check via email service mock)
  - [ ] Reset token expires after 1 hour
  - [ ] Old password no longer works
  - [ ] New password meets complexity requirements
  - [ ] Token can only be used once

#### TR-006: Profile Management
- **Traces to**: US-21, US-22, US-23 (View profile, Edit profile, Change password)
- **Type**: Integration + E2E
- **Component Under Test**: GET /api/auth/me, PATCH /api/auth/profile
- **Test Scenarios**:
  - [ ] View current profile returns correct data
  - [ ] Update name successfully
  - [ ] Change password with correct currentPassword
  - [ ] Change password fails with wrong currentPassword (422)
  - [ ] Cannot change password without currentPassword (400)

#### TR-007: Invitation Acceptance
- **Traces to**: US-5 (Accept invitation)
- **Type**: Integration + E2E
- **Component Under Test**: POST /api/invitations/:token/accept, AcceptInvitePage
- **Preconditions**: Valid invitation token exists
- **Test Input**: Name, password, confirmation password
- **Expected Result**: User created, auto-logged in, added to organization
- **Verification Points**:
  - [ ] User created with invited organization
  - [ ] User role matches invitation role
  - [ ] Invitation marked as accepted (cannot be reused)
  - [ ] User redirected to /dashboard
  - [ ] JWT token issued immediately

#### TR-008: Logout
- **Traces to**: Authentication flow
- **Type**: Integration + E2E
- **Component Under Test**: POST /api/auth/logout
- **Test Input**: Valid JWT token
- **Expected Result**: 204 No Content
- **Verification Points**:
  - [ ] Token cleared from localStorage
  - [ ] User redirected to /login
  - [ ] Subsequent requests with old token fail (401)

### 3.2 Project Management Stories

#### TR-009: View Dashboard
- **Traces to**: US-6 (View dashboard)
- **Type**: E2E + Integration
- **Component Under Test**: GET /api/projects, DashboardPage
- **Preconditions**: User authenticated, has projects
- **Expected Result**: Projects list displayed with pagination
- **Verification Points**:
  - [ ] Only user's organization projects shown
  - [ ] Projects sorted by updatedAt desc
  - [ ] Pagination works (page, page_size params)
  - [ ] Empty state shown when no projects
  - [ ] Project cards show: name, description, status, lastUpdated

#### TR-010: Create Project
- **Traces to**: US-7 (Create project)
- **Type**: Integration + E2E
- **Component Under Test**: POST /api/projects, ProjectCreatePage
- **Preconditions**: User has Admin or Editor role
- **Test Input**: Project name, description
- **Expected Result**: 201 Created, project created in database
- **Verification Points**:
  - [ ] Project created with authenticated user's organisationId
  - [ ] createdBy set to current user
  - [ ] status defaults to "draft"
  - [ ] Project accessible via GET /api/projects/:projectId
  - [ ] User redirected to /projects/:id

#### TR-011: View Project Detail
- **Traces to**: US-9 (View project detail)
- **Type**: E2E + Integration
- **Component Under Test**: GET /api/projects/:projectId, ProjectDetailPage
- **Preconditions**: Project exists in user's organization
- **Expected Result**: Project details displayed
- **Verification Points**:
  - [ ] Project metadata shown (name, description, created date, status)
  - [ ] Data sources list displayed
  - [ ] Processing jobs list displayed
  - [ ] Datasets list displayed
  - [ ] 404 error for non-existent projectId
  - [ ] 403 error for project from different organization

#### TR-012: Update Project
- **Traces to**: US-19 (Edit project)
- **Type**: Integration + E2E
- **Component Under Test**: PATCH /api/projects/:projectId, ProjectEditPage
- **Preconditions**: User has Admin or Editor role, project exists
- **Test Input**: Updated name, description
- **Expected Result**: 200 OK, project updated
- **Verification Points**:
  - [ ] Project name updated in database
  - [ ] updatedAt timestamp changed
  - [ ] Viewer role cannot update (403)
  - [ ] Cannot update project from different organization (403)

#### TR-013: Delete Project
- **Traces to**: US-20 (Delete project)
- **Type**: Integration + E2E
- **Component Under Test**: DELETE /api/projects/:projectId
- **Preconditions**: User has Admin role, project exists
- **Test Input**: Project ID
- **Expected Result**: 204 No Content, soft delete
- **Verification Points**:
  - [ ] Project deletedAt timestamp set (soft delete)
  - [ ] Project no longer appears in list
  - [ ] Associated resources marked deleted (data sources, jobs, datasets)
  - [ ] Editor role cannot delete (403)
  - [ ] Viewer role cannot delete (403)

#### TR-014: Project Summary Statistics
- **Traces to**: US-6 (Dashboard metrics)
- **Type**: Integration
- **Component Under Test**: GET /api/projects/:projectId/summary
- **Preconditions**: Project with data sources and jobs
- **Expected Result**: Statistics object returned
- **Verification Points**:
  - [ ] Counts: dataSourceCount, jobCount, datasetCount
  - [ ] Last processing job status and timestamp
  - [ ] Total records processed
  - [ ] Storage size used

### 3.3 Data Source Management Stories

#### TR-015: Upload File Data Source
- **Traces to**: US-10 (Upload file)
- **Type**: Integration + E2E
- **Component Under Test**: POST /api/projects/:projectId/data-sources, DataSourceUploadPage
- **Preconditions**: User has Admin or Editor role
- **Test Input**: Multipart form data with CSV file
- **Expected Result**: 201 Created, file uploaded to S3, metadata in database
- **Verification Points**:
  - [ ] File uploaded to S3 with correct key (projectId/sourceId/filename)
  - [ ] Data source record created with type="file"
  - [ ] File size validated (<100MB)
  - [ ] MIME type validated (CSV, JSON, XML, XLSX)
  - [ ] Progress indicator shown during upload
  - [ ] Virus scan performed before S3 upload

#### TR-016: Connect Teamwork Desk OAuth
- **Traces to**: US-11 (Connect Teamwork Desk)
- **Type**: Integration + E2E
- **Component Under Test**: POST /api/oauth/connections, OAuthConnectPage
- **Preconditions**: User has Admin or Editor role
- **Test Flow**:
  1. Initiate OAuth flow
  2. User redirects to Teamwork authorization
  3. Callback with authorization code
  4. Exchange code for tokens
  5. Encrypt and store tokens
  6. Create data source connection
- **Verification Points**:
  - [ ] OAuth tokens encrypted before database storage
  - [ ] Refresh token stored for future use
  - [ ] Connection status "active"
  - [ ] User redirected back to project after OAuth
  - [ ] Can import data from connected Teamwork account

#### TR-017: Preview Data Source
- **Traces to**: US-12 (Preview data)
- **Type**: Integration + E2E
- **Component Under Test**: GET /api/data-sources/:sourceId/preview, DataPreviewPage
- **Preconditions**: Data source exists with uploaded file
- **Expected Result**: First 100 rows returned for preview
- **Verification Points**:
  - [ ] Returns maximum 100 rows
  - [ ] Columns detected automatically from file
  - [ ] JSON structure flattened for tabular display
  - [ ] Pagination not applied (fixed 100 rows)
  - [ ] Data sanitized (no PII revealed in preview)

#### TR-018: Update Data Source Configuration
- **Traces to**: Configuration management
- **Type**: Integration
- **Component Under Test**: PATCH /api/data-sources/:sourceId
- **Test Scenarios**:
  - [ ] Update file format metadata
  - [ ] Update import configuration for OAuth connection
  - [ ] Cannot update source from different organization (403)
  - [ ] Viewer role cannot update (403)

#### TR-019: Delete Data Source
- **Traces to**: Data management
- **Type**: Integration
- **Component Under Test**: DELETE /api/data-sources/:sourceId
- **Preconditions**: User has Admin or Editor role
- **Expected Result**: 204 No Content, soft delete
- **Verification Points**:
  - [ ] Data source deletedAt timestamp set
  - [ ] File remains in S3 (not deleted immediately)
  - [ ] Associated schema mappings deleted
  - [ ] Admin role required (403 for others)

#### TR-020: List Project Data Sources
- **Traces to**: US-8, US-9 (Project views)
- **Type**: Integration
- **Component Under Test**: GET /api/projects/:projectId/data-sources
- **Expected Result**: Paginated list of data sources
- **Verification Points**:
  - [ ] Only sources for specified project
  - [ ] Includes: id, name, type, format, size, status, createdAt
  - [ ] Pagination applied (default 20 per page)
  - [ ] Soft-deleted sources excluded

### 3.4 Schema Mapping Stories

#### TR-021: Create Schema Mapping
- **Traces to**: US-13 (Configure schema mapping)
- **Type**: Integration + E2E
- **Component Under Test**: POST /api/projects/:projectId/schema-mappings, SchemaMappingPage
- **Preconditions**: Data source exists with preview data
- **Test Input**: Mapping configuration (source columns → target schema fields)
- **Expected Result**: 201 Created, mapping saved
- **Verification Points**:
  - [ ] Mapping config stored as JSONB
  - [ ] Canonical schema: conversation (message_id, role, message_text, timestamp, thread_id, metadata)
  - [ ] Source column types validated
  - [ ] Required fields mapped (message_id, message_text)
  - [ ] Transform functions stored (e.g., date parsing, role normalization)

#### TR-022: Configure PII Detection Rules
- **Traces to**: US-14 (Configure PII detection)
- **Type**: Integration + E2E
- **Component Under Test**: Schema mapping configuration, SchemaMappingPage
- **Test Input**: PII detection rules (email, phone, SSN, name, address)
- **Expected Result**: Rules saved in mapping config
- **Verification Points**:
  - [ ] Detection rules: REDACT, MASK, REMOVE_FIELD
  - [ ] Custom regex patterns supported
  - [ ] Named entity recognition enabled (compromise.js)
  - [ ] Rules applied per field (granular control)
  - [ ] Detection threshold configurable (sensitivity)

#### TR-023: View Schema Mapping
- **Traces to**: Configuration review
- **Type**: Integration
- **Component Under Test**: GET /api/schema-mappings/:mappingId
- **Expected Result**: Full mapping configuration returned
- **Verification Points**:
  - [ ] Source schema structure
  - [ ] Target schema structure
  - [ ] Field mappings with transformations
  - [ ] PII detection rules
  - [ ] Validation rules

#### TR-024: Update Schema Mapping
- **Traces to**: Configuration iteration
- **Type**: Integration + E2E
- **Component Under Test**: PATCH /api/schema-mappings/:mappingId
- **Test Input**: Modified mapping configuration
- **Expected Result**: 200 OK, mapping updated
- **Verification Points**:
  - [ ] Configuration changes persisted
  - [ ] updatedAt timestamp updated
  - [ ] Existing jobs not affected (use mapping version)
  - [ ] Editor and Admin roles can update
  - [ ] Viewer role cannot update (403)

#### TR-025: Delete Schema Mapping
- **Traces to**: Configuration management
- **Type**: Integration
- **Component Under Test**: DELETE /api/schema-mappings/:mappingId
- **Preconditions**: No active processing jobs using mapping
- **Expected Result**: 204 No Content
- **Verification Points**:
  - [ ] Soft delete (deletedAt timestamp)
  - [ ] Cannot delete if jobs reference mapping
  - [ ] Admin role required

### 3.5 Processing Job Stories

#### TR-026: Start Processing Job
- **Traces to**: US-15 (Start processing)
- **Type**: Integration + E2E
- **Component Under Test**: POST /api/projects/:projectId/jobs, ProcessingJobPage
- **Preconditions**: Data source and schema mapping exist
- **Test Input**: Job configuration (dataSourceId, mappingId, options)
- **Expected Result**: 201 Created, job queued
- **Verification Points**:
  - [ ] Job created with status="pending"
  - [ ] Job moved to "processing" status
  - [ ] Rate limiting enforced (10 jobs/60s)
  - [ ] Job assigned unique ID
  - [ ] Progress tracking initialized (0%)

#### TR-027: Monitor Job Progress
- **Traces to**: US-16 (Monitor progress)
- **Type**: Integration + E2E
- **Component Under Test**: GET /api/jobs/:jobId/progress, ProcessingJobPage
- **Expected Result**: Real-time progress data
- **Verification Points**:
  - [ ] Progress percentage (0-100)
  - [ ] Current stage (parsing, mapping, detecting_pii, exporting)
  - [ ] Records processed count
  - [ ] Estimated time remaining
  - [ ] Error count
  - [ ] Poll interval: 2-5 seconds

#### TR-028: Processing Job Execution
- **Traces to**: US-15, US-16 (Processing pipeline)
- **Type**: Integration
- **Component Under Test**: Processing service
- **Test Flow**: Complete processing pipeline
- **Verification Points**:
  - [ ] File downloaded from S3
  - [ ] File parsed (CSV, JSON, XML, XLSX)
  - [ ] Schema mapping applied
  - [ ] PII detection executed (compromise.js + regex)
  - [ ] Records transformed to target schema
  - [ ] Dataset exported to S3 (JSON, CSV, JSONL)
  - [ ] Job status updated to "completed"
  - [ ] Processing time <30 minutes for 100k records

#### TR-029: Processing Job Error Handling
- **Traces to**: Error handling requirements
- **Type**: Integration
- **Component Under Test**: Processing service error scenarios
- **Test Scenarios**:

| Scenario | Trigger | Expected Result |
|----------|---------|-----------------|
| File parse error | Invalid JSON | Job status "failed", error logged |
| S3 download failure | Network error | Job status "failed", retryable |
| Mapping error | Invalid field type | Job status "failed", specific error |
| Timeout | Processing >30 min | Job status "failed", partial results |
| PII detection failure | Library error | Job continues with warning |

#### TR-030: Cancel Running Job
- **Traces to**: Job control
- **Type**: Integration + E2E
- **Component Under Test**: POST /api/jobs/:jobId/cancel
- **Preconditions**: Job in "processing" status
- **Expected Result**: 200 OK, job cancelled
- **Verification Points**:
  - [ ] Job status changed to "cancelled"
  - [ ] Processing engine stops gracefully
  - [ ] Partial results preserved (if any)
  - [ ] Resources cleaned up
  - [ ] Cannot cancel completed jobs

#### TR-031: View Job Logs
- **Traces to**: Debugging and audit
- **Type**: Integration
- **Component Under Test**: GET /api/jobs/:jobId/logs
- **Expected Result**: Structured log entries
- **Verification Points**:
  - [ ] Log levels: INFO, WARN, ERROR
  - [ ] Timestamps for each entry
  - [ ] Stage markers (parsing started, PII detection complete)
  - [ ] Error details with stack traces
  - [ ] Records processed counts

#### TR-032: List Project Jobs
- **Traces to**: Job history
- **Type**: Integration
- **Component Under Test**: GET /api/projects/:projectId/jobs
- **Expected Result**: Paginated job list
- **Verification Points**:
  - [ ] Jobs sorted by createdAt desc
  - [ ] Status filter support (pending, processing, completed, failed)
  - [ ] Includes: id, status, progress, createdAt, completedAt, recordsProcessed
  - [ ] Pagination applied (default 20 per page)

### 3.6 Dataset Stories

#### TR-033: View Processing Results
- **Traces to**: US-17 (View results)
- **Type**: E2E + Integration
- **Component Under Test**: GET /api/datasets/:datasetId, DatasetDetailPage
- **Preconditions**: Processing job completed successfully
- **Expected Result**: Dataset metadata and statistics
- **Verification Points**:
  - [ ] Record count
  - [ ] File size
  - [ ] PII fields detected and action taken
  - [ ] Schema structure
  - [ ] Export formats available (JSON, CSV, JSONL)
  - [ ] Generated timestamp
  - [ ] Source job reference

#### TR-034: Preview Dataset
- **Traces to**: Data quality verification
- **Type**: Integration + E2E
- **Component Under Test**: GET /api/datasets/:datasetId/preview
- **Expected Result**: First 100 records
- **Verification Points**:
  - [ ] Records match target schema exactly
  - [ ] PII redaction applied correctly
  - [ ] Transformed fields correct
  - [ ] Timestamps in ISO 8601 format
  - [ ] Thread grouping preserved

#### TR-035: Download Dataset
- **Traces to**: US-18 (Download dataset)
- **Type**: Integration + E2E
- **Component Under Test**: GET /api/datasets/:datasetId/download, DatasetDetailPage
- **Test Input**: Format query parameter (json, csv, jsonl)
- **Expected Result**: Signed S3 URL or file stream
- **Verification Points**:
  - [ ] File available in requested format
  - [ ] Content-Disposition header with filename
  - [ ] File size matches metadata
  - [ ] JSON: prettified with 2-space indent
  - [ ] CSV: proper escaping and headers
  - [ ] JSONL: one record per line
  - [ ] Download tracked in audit log

#### TR-036: List Project Datasets
- **Traces to**: Dataset management
- **Type**: Integration
- **Component Under Test**: GET /api/projects/:projectId/datasets
- **Expected Result**: Paginated dataset list
- **Verification Points**:
  - [ ] Datasets sorted by createdAt desc
  - [ ] Includes: id, name, recordCount, size, format, createdAt
  - [ ] Links to source job
  - [ ] Pagination applied (default 20 per page)
  - [ ] Soft-deleted datasets excluded

### 3.7 Organization & Team Stories

#### TR-037: View Organization Settings
- **Traces to**: US-27 (View organization settings)
- **Type**: Integration + E2E
- **Component Under Test**: GET /api/organisations/current, OrganizationSettingsPage
- **Preconditions**: User authenticated
- **Expected Result**: Organization details
- **Verification Points**:
  - [ ] Organization name, slug
  - [ ] Member count
  - [ ] Created date
  - [ ] Subscription/plan info (if applicable)

#### TR-038: Update Organization Settings
- **Traces to**: US-27 (Update organization settings)
- **Type**: Integration
- **Component Under Test**: PATCH /api/organisations/current
- **Preconditions**: User has Admin role
- **Test Input**: Updated organization name
- **Expected Result**: 200 OK, organization updated
- **Verification Points**:
  - [ ] Organization name updated
  - [ ] Only Admin role can update (403 for others)
  - [ ] Slug cannot be changed (immutable)

#### TR-039: List Team Members
- **Traces to**: US-24, US-28 (View team members, Manage roles)
- **Type**: Integration + E2E
- **Component Under Test**: GET /api/organisations/members, TeamMembersPage
- **Preconditions**: User has Admin role
- **Expected Result**: List of organization members
- **Verification Points**:
  - [ ] All members of organization shown
  - [ ] Includes: name, email, role, status, lastLoginAt
  - [ ] Current user highlighted
  - [ ] Pending invitations shown separately

#### TR-040: Invite Team Member
- **Traces to**: US-25 (Invite team member)
- **Type**: Integration + E2E
- **Component Under Test**: POST /api/organisations/members/invite, InviteMemberDialog
- **Preconditions**: User has Admin role
- **Test Input**: Email, role (admin, editor, viewer)
- **Expected Result**: 201 Created, invitation email sent
- **Verification Points**:
  - [ ] Invitation record created with unique token
  - [ ] Email sent via Resend with invitation link
  - [ ] Token expires after 7 days
  - [ ] Cannot invite existing member (409)
  - [ ] Duplicate pending invitation returns existing invitation
  - [ ] Only Admin can invite (403 for others)

#### TR-041: Remove Team Member
- **Traces to**: US-26 (Remove team member)
- **Type**: Integration
- **Component Under Test**: DELETE /api/organisations/members/:userId
- **Preconditions**: User has Admin role
- **Expected Result**: 204 No Content, user removed
- **Verification Points**:
  - [ ] User's role changed to "removed"
  - [ ] User can no longer access organization resources (403)
  - [ ] Cannot remove self
  - [ ] Cannot remove last admin
  - [ ] Only Admin can remove (403 for others)

#### TR-042: Change Member Role
- **Traces to**: US-28 (Manage roles)
- **Type**: Integration
- **Component Under Test**: PATCH /api/organisations/members/:userId
- **Preconditions**: User has Admin role
- **Test Input**: New role (admin, editor, viewer)
- **Expected Result**: 200 OK, role updated
- **Verification Points**:
  - [ ] User's role updated in database
  - [ ] Role takes effect immediately (permissions change)
  - [ ] Cannot change self to non-admin if last admin
  - [ ] Only Admin can change roles (403 for others)

---

## 4. API Endpoint Test Scenarios

### 4.1 Authentication Endpoints (8 total)

#### API: POST /api/auth/register

| Scenario | Input | Expected Status | Expected Response | Traces To |
|----------|-------|-----------------|-------------------|-----------|
| Valid registration | Valid email, password, name | 201 | `{ data: { token, user } }` | TR-001 |
| Duplicate email | Existing email | 409 | `{ error: { code: "DUPLICATE_EMAIL" } }` | TR-002 |
| Invalid email | "not-email" | 400 | `{ error: { code: "VALIDATION_ERROR" } }` | TR-002 |
| Weak password | "short" | 400 | `{ error: { code: "VALIDATION_ERROR" } }` | TR-002 |
| With invite token | Valid inviteToken | 201 | User added to invited org | TR-007 |
| Invalid invite token | Bad UUID | 410 | `{ error: { code: "INVALID_TOKEN" } }` | TR-007 |

#### API: POST /api/auth/login

| Scenario | Input | Expected Status | Expected Response | Traces To |
|----------|-------|-----------------|-------------------|-----------|
| Valid credentials | Correct email & password | 200 | `{ data: { token, user } }` | TR-003 |
| Wrong password | Invalid password | 401 | `{ error: { code: "INVALID_CREDENTIALS" } }` | TR-004 |
| Non-existent user | Unknown email | 401 | `{ error: { code: "INVALID_CREDENTIALS" } }` | TR-004 |
| Rate limit exceeded | 6th request in 15min | 429 | `{ error: { code: "RATE_LIMIT_EXCEEDED" } }` | TR-004 |

#### API: POST /api/auth/logout

| Scenario | Input | Expected Status | Expected Response | Traces To |
|----------|-------|-----------------|-------------------|-----------|
| Valid token | Bearer token in header | 204 | Empty body | TR-008 |
| No token | Missing Authorization | 401 | `{ error: { code: "UNAUTHORIZED" } }` | TR-008 |
| Invalid token | Malformed JWT | 401 | `{ error: { code: "UNAUTHORIZED" } }` | TR-008 |

#### API: GET /api/auth/me

| Scenario | Input | Expected Status | Expected Response | Traces To |
|----------|-------|-----------------|-------------------|-----------|
| Valid token | Bearer token | 200 | `{ data: { user } }` | TR-006 |
| Expired token | Token past 24h | 401 | `{ error: { code: "UNAUTHORIZED" } }` | TR-006 |
| No token | Missing Authorization | 401 | `{ error: { code: "UNAUTHORIZED" } }` | TR-006 |

#### API: PATCH /api/auth/profile

| Scenario | Input | Expected Status | Expected Response | Traces To |
|----------|-------|-----------------|-------------------|-----------|
| Update name | Valid name | 200 | `{ data: { user } }` with updated name | TR-006 |
| Change password | currentPassword + newPassword | 200 | `{ data: { user } }` | TR-006 |
| Wrong current password | Incorrect currentPassword | 422 | `{ error: { code: "UNPROCESSABLE_ENTITY" } }` | TR-006 |
| Weak new password | Password too short | 400 | `{ error: { code: "VALIDATION_ERROR" } }` | TR-006 |

#### API: POST /api/auth/forgot-password

| Scenario | Input | Expected Status | Expected Response | Traces To |
|----------|-------|-----------------|-------------------|-----------|
| Existing email | Valid registered email | 200 | `{ data: { message } }` | TR-005 |
| Non-existent email | Unknown email | 200 | `{ data: { message } }` (same response) | TR-005 |
| Invalid email format | "not-email" | 400 | `{ error: { code: "VALIDATION_ERROR" } }` | TR-005 |
| Rate limit | 6th request in 15min | 429 | `{ error: { code: "RATE_LIMIT_EXCEEDED" } }` | TR-005 |

#### API: GET /api/auth/reset-password/:token

| Scenario | Input | Expected Status | Expected Response | Traces To |
|----------|-------|-----------------|-------------------|-----------|
| Valid token | Active reset token | 200 | `{ data: { valid: true, email } }` | TR-005 |
| Expired token | Token >1 hour old | 410 | `{ error: { code: "INVALID_TOKEN" } }` | TR-005 |
| Used token | Already used token | 410 | `{ error: { code: "INVALID_TOKEN" } }` | TR-005 |
| Invalid token | Non-existent token | 410 | `{ error: { code: "INVALID_TOKEN" } }` | TR-005 |

#### API: POST /api/auth/reset-password

| Scenario | Input | Expected Status | Expected Response | Traces To |
|----------|-------|-----------------|-------------------|-----------|
| Valid reset | Valid token + new password | 200 | `{ data: { message } }` | TR-005 |
| Invalid token | Bad token | 410 | `{ error: { code: "INVALID_TOKEN" } }` | TR-005 |
| Weak password | Short password | 400 | `{ error: { code: "VALIDATION_ERROR" } }` | TR-005 |

### 4.2 Projects Endpoints (6 total)

#### API: GET /api/projects

| Scenario | Input | Expected Status | Expected Response | Traces To |
|----------|-------|-----------------|-------------------|-----------|
| List user projects | Valid auth | 200 | `{ data: [...], pagination }` | TR-009 |
| Empty list | No projects | 200 | `{ data: [], pagination }` | TR-009 |
| Pagination | page=2, page_size=10 | 200 | Second page of results | TR-009 |
| Unauthorized | No token | 401 | `{ error: { code: "UNAUTHORIZED" } }` | TR-009 |

#### API: POST /api/projects

| Scenario | Input | Expected Status | Expected Response | Traces To |
|----------|-------|-----------------|-------------------|-----------|
| Create project | Valid name, description | 201 | `{ data: { project } }` | TR-010 |
| Missing name | Empty name | 400 | `{ error: { code: "VALIDATION_ERROR" } }` | TR-010 |
| Viewer role | Viewer attempts create | 403 | `{ error: { code: "FORBIDDEN" } }` | TR-010 |

#### API: GET /api/projects/:projectId

| Scenario | Input | Expected Status | Expected Response | Traces To |
|----------|-------|-----------------|-------------------|-----------|
| Get own project | Valid projectId | 200 | `{ data: { project } }` | TR-011 |
| Non-existent project | Invalid ID | 404 | `{ error: { code: "NOT_FOUND" } }` | TR-011 |
| Other org project | Project from different org | 403 | `{ error: { code: "FORBIDDEN" } }` | TR-011 |
| Invalid ID format | String instead of int | 400 | `{ error: { code: "INVALID_ID" } }` | TR-011 |

#### API: PATCH /api/projects/:projectId

| Scenario | Input | Expected Status | Expected Response | Traces To |
|----------|-------|-----------------|-------------------|-----------|
| Update project | New name, description | 200 | `{ data: { project } }` with updates | TR-012 |
| Viewer role | Viewer attempts update | 403 | `{ error: { code: "FORBIDDEN" } }` | TR-012 |
| Non-existent project | Invalid ID | 404 | `{ error: { code: "NOT_FOUND" } }` | TR-012 |

#### API: DELETE /api/projects/:projectId

| Scenario | Input | Expected Status | Expected Response | Traces To |
|----------|-------|-----------------|-------------------|-----------|
| Delete project | Admin user | 204 | Empty body | TR-013 |
| Editor role | Editor attempts delete | 403 | `{ error: { code: "FORBIDDEN" } }` | TR-013 |
| Viewer role | Viewer attempts delete | 403 | `{ error: { code: "FORBIDDEN" } }` | TR-013 |
| Non-existent project | Invalid ID | 404 | `{ error: { code: "NOT_FOUND" } }` | TR-013 |

#### API: GET /api/projects/:projectId/summary

| Scenario | Input | Expected Status | Expected Response | Traces To |
|----------|-------|-----------------|-------------------|-----------|
| Get summary | Valid projectId | 200 | `{ data: { statistics } }` | TR-014 |
| Empty project | No data sources | 200 | All counts zero | TR-014 |
| Non-existent project | Invalid ID | 404 | `{ error: { code: "NOT_FOUND" } }` | TR-014 |

### 4.3 Data Sources Endpoints (6 total)

#### API: POST /api/projects/:projectId/data-sources

| Scenario | Input | Expected Status | Expected Response | Traces To |
|----------|-------|-----------------|-------------------|-----------|
| Upload CSV | multipart/form-data with CSV | 201 | `{ data: { dataSource } }` | TR-015 |
| Upload JSON | multipart/form-data with JSON | 201 | `{ data: { dataSource } }` | TR-015 |
| File too large | >100MB file | 413 | `{ error: { code: "FILE_TOO_LARGE" } }` | TR-015 |
| Invalid file type | .txt file | 400 | `{ error: { code: "VALIDATION_ERROR" } }` | TR-015 |
| Viewer role | Viewer attempts upload | 403 | `{ error: { code: "FORBIDDEN" } }` | TR-015 |

#### API: GET /api/projects/:projectId/data-sources

| Scenario | Input | Expected Status | Expected Response | Traces To |
|----------|-------|-----------------|-------------------|-----------|
| List sources | Valid projectId | 200 | `{ data: [...], pagination }` | TR-020 |
| Empty list | No sources | 200 | `{ data: [], pagination }` | TR-020 |
| Pagination | page=1, page_size=20 | 200 | Paginated list | TR-020 |

#### API: GET /api/data-sources/:sourceId

| Scenario | Input | Expected Status | Expected Response | Traces To |
|----------|-------|-----------------|-------------------|-----------|
| Get source | Valid sourceId | 200 | `{ data: { dataSource } }` | TR-017 |
| Non-existent source | Invalid ID | 404 | `{ error: { code: "NOT_FOUND" } }` | TR-017 |
| Other org source | Source from different org | 403 | `{ error: { code: "FORBIDDEN" } }` | TR-017 |

#### API: GET /api/data-sources/:sourceId/preview

| Scenario | Input | Expected Status | Expected Response | Traces To |
|----------|-------|-----------------|-------------------|-----------|
| Preview CSV | Valid sourceId | 200 | `{ data: { rows } }` (max 100) | TR-017 |
| Preview JSON | JSON source | 200 | Flattened rows | TR-017 |
| Source not ready | Still uploading | 422 | `{ error: { code: "UNPROCESSABLE_ENTITY" } }` | TR-017 |

#### API: PATCH /api/data-sources/:sourceId

| Scenario | Input | Expected Status | Expected Response | Traces To |
|----------|-------|-----------------|-------------------|-----------|
| Update config | New configuration | 200 | `{ data: { dataSource } }` | TR-018 |
| Viewer role | Viewer attempts update | 403 | `{ error: { code: "FORBIDDEN" } }` | TR-018 |

#### API: DELETE /api/data-sources/:sourceId

| Scenario | Input | Expected Status | Expected Response | Traces To |
|----------|-------|-----------------|-------------------|-----------|
| Delete source | Admin user | 204 | Empty body | TR-019 |
| Editor delete | Editor user | 204 | Empty body | TR-019 |
| Viewer role | Viewer attempts delete | 403 | `{ error: { code: "FORBIDDEN" } }` | TR-019 |

### 4.4 Schema Mappings Endpoints (5 total)

#### API: POST /api/projects/:projectId/schema-mappings

| Scenario | Input | Expected Status | Expected Response | Traces To |
|----------|-------|-----------------|-------------------|-----------|
| Create mapping | Valid mapping config | 201 | `{ data: { schemaMapping } }` | TR-021 |
| Invalid config | Missing required fields | 400 | `{ error: { code: "VALIDATION_ERROR" } }` | TR-021 |
| Viewer role | Viewer attempts create | 403 | `{ error: { code: "FORBIDDEN" } }` | TR-021 |

#### API: GET /api/projects/:projectId/schema-mappings

| Scenario | Input | Expected Status | Expected Response | Traces To |
|----------|-------|-----------------|-------------------|-----------|
| List mappings | Valid projectId | 200 | `{ data: [...], pagination }` | TR-023 |
| Empty list | No mappings | 200 | `{ data: [], pagination }` | TR-023 |

#### API: GET /api/schema-mappings/:mappingId

| Scenario | Input | Expected Status | Expected Response | Traces To |
|----------|-------|-----------------|-------------------|-----------|
| Get mapping | Valid mappingId | 200 | `{ data: { schemaMapping } }` | TR-023 |
| Non-existent mapping | Invalid ID | 404 | `{ error: { code: "NOT_FOUND" } }` | TR-023 |

#### API: PATCH /api/schema-mappings/:mappingId

| Scenario | Input | Expected Status | Expected Response | Traces To |
|----------|-------|-----------------|-------------------|-----------|
| Update mapping | Modified config | 200 | `{ data: { schemaMapping } }` | TR-024 |
| Viewer role | Viewer attempts update | 403 | `{ error: { code: "FORBIDDEN" } }` | TR-024 |

#### API: DELETE /api/schema-mappings/:mappingId

| Scenario | Input | Expected Status | Expected Response | Traces To |
|----------|-------|-----------------|-------------------|-----------|
| Delete mapping | Admin user | 204 | Empty body | TR-025 |
| In-use mapping | Mapping used by jobs | 422 | `{ error: { code: "UNPROCESSABLE_ENTITY" } }` | TR-025 |

### 4.5 Processing Jobs Endpoints (6 total)

#### API: POST /api/projects/:projectId/jobs

| Scenario | Input | Expected Status | Expected Response | Traces To |
|----------|-------|-----------------|-------------------|-----------|
| Start job | Valid config | 201 | `{ data: { job } }` | TR-026 |
| Rate limit | 11th job in 60s | 429 | `{ error: { code: "RATE_LIMIT_EXCEEDED" } }` | TR-026 |
| Missing data source | No dataSourceId | 400 | `{ error: { code: "VALIDATION_ERROR" } }` | TR-026 |
| Viewer role | Viewer attempts start | 403 | `{ error: { code: "FORBIDDEN" } }` | TR-026 |

#### API: GET /api/projects/:projectId/jobs

| Scenario | Input | Expected Status | Expected Response | Traces To |
|----------|-------|-----------------|-------------------|-----------|
| List jobs | Valid projectId | 200 | `{ data: [...], pagination }` | TR-032 |
| Filter by status | status=completed | 200 | Only completed jobs | TR-032 |
| Empty list | No jobs | 200 | `{ data: [], pagination }` | TR-032 |

#### API: GET /api/jobs/:jobId

| Scenario | Input | Expected Status | Expected Response | Traces To |
|----------|-------|-----------------|-------------------|-----------|
| Get job | Valid jobId | 200 | `{ data: { job } }` | TR-027 |
| Non-existent job | Invalid ID | 404 | `{ error: { code: "NOT_FOUND" } }` | TR-027 |

#### API: GET /api/jobs/:jobId/progress

| Scenario | Input | Expected Status | Expected Response | Traces To |
|----------|-------|-----------------|-------------------|-----------|
| Get progress | Running job | 200 | `{ data: { progress, stage, percentage } }` | TR-027 |
| Completed job | Finished job | 200 | `{ data: { progress: 100, stage: "completed" } }` | TR-027 |

#### API: POST /api/jobs/:jobId/cancel

| Scenario | Input | Expected Status | Expected Response | Traces To |
|----------|-------|-----------------|-------------------|-----------|
| Cancel job | Running job | 200 | `{ data: { job } }` with status="cancelled" | TR-030 |
| Already completed | Completed job | 422 | `{ error: { code: "UNPROCESSABLE_ENTITY" } }` | TR-030 |

#### API: GET /api/jobs/:jobId/logs

| Scenario | Input | Expected Status | Expected Response | Traces To |
|----------|-------|-----------------|-------------------|-----------|
| Get logs | Valid jobId | 200 | `{ data: { logs: [...] } }` | TR-031 |
| Pagination | page=1, page_size=50 | 200 | Paginated logs | TR-031 |

### 4.6 Datasets Endpoints (4 total)

#### API: GET /api/projects/:projectId/datasets

| Scenario | Input | Expected Status | Expected Response | Traces To |
|----------|-------|-----------------|-------------------|-----------|
| List datasets | Valid projectId | 200 | `{ data: [...], pagination }` | TR-036 |
| Empty list | No datasets | 200 | `{ data: [], pagination }` | TR-036 |

#### API: GET /api/datasets/:datasetId

| Scenario | Input | Expected Status | Expected Response | Traces To |
|----------|-------|-----------------|-------------------|-----------|
| Get dataset | Valid datasetId | 200 | `{ data: { dataset } }` | TR-033 |
| Non-existent | Invalid ID | 404 | `{ error: { code: "NOT_FOUND" } }` | TR-033 |

#### API: GET /api/datasets/:datasetId/preview

| Scenario | Input | Expected Status | Expected Response | Traces To |
|----------|-------|-----------------|-------------------|-----------|
| Preview dataset | Valid datasetId | 200 | `{ data: { rows } }` (max 100) | TR-034 |
| Empty dataset | No records | 200 | `{ data: { rows: [] } }` | TR-034 |

#### API: GET /api/datasets/:datasetId/download

| Scenario | Input | Expected Status | Expected Response | Traces To |
|----------|-------|-----------------|-------------------|-----------|
| Download JSON | format=json | 200 | JSON file stream | TR-035 |
| Download CSV | format=csv | 200 | CSV file stream | TR-035 |
| Download JSONL | format=jsonl | 200 | JSONL file stream | TR-035 |
| Invalid format | format=xml | 400 | `{ error: { code: "VALIDATION_ERROR" } }` | TR-035 |

### 4.7 OAuth Connections Endpoints (3 total)

#### API: POST /api/oauth/connections

| Scenario | Input | Expected Status | Expected Response | Traces To |
|----------|-------|-----------------|-------------------|-----------|
| Connect Teamwork | OAuth authorization code | 201 | `{ data: { connection } }` | TR-016 |
| Invalid code | Bad auth code | 400 | `{ error: { code: "VALIDATION_ERROR" } }` | TR-016 |
| Viewer role | Viewer attempts connect | 403 | `{ error: { code: "FORBIDDEN" } }` | TR-016 |

#### API: GET /api/oauth/connections

| Scenario | Input | Expected Status | Expected Response | Traces To |
|----------|-------|-----------------|-------------------|-----------|
| List connections | Valid auth | 200 | `{ data: [...] }` | TR-016 |
| Empty list | No connections | 200 | `{ data: [] }` | TR-016 |

#### API: DELETE /api/oauth/connections/:connectionId

| Scenario | Input | Expected Status | Expected Response | Traces To |
|----------|-------|-----------------|-------------------|-----------|
| Delete connection | Admin user | 204 | Empty body | TR-016 |
| Viewer role | Viewer attempts delete | 403 | `{ error: { code: "FORBIDDEN" } }` | TR-016 |

### 4.8 Organisations Endpoints (4 total)

#### API: GET /api/organisations/current

| Scenario | Input | Expected Status | Expected Response | Traces To |
|----------|-------|-----------------|-------------------|-----------|
| Get org | Valid auth | 200 | `{ data: { organisation } }` | TR-037 |

#### API: PATCH /api/organisations/current

| Scenario | Input | Expected Status | Expected Response | Traces To |
|----------|-------|-----------------|-------------------|-----------|
| Update org | Admin user, new name | 200 | `{ data: { organisation } }` | TR-038 |
| Editor role | Editor attempts update | 403 | `{ error: { code: "FORBIDDEN" } }` | TR-038 |

#### API: GET /api/organisations/members

| Scenario | Input | Expected Status | Expected Response | Traces To |
|----------|-------|-----------------|-------------------|-----------|
| List members | Admin user | 200 | `{ data: [...] }` | TR-039 |
| Editor role | Editor attempts list | 403 | `{ error: { code: "FORBIDDEN" } }` | TR-039 |

#### API: POST /api/organisations/members/invite

| Scenario | Input | Expected Status | Expected Response | Traces To |
|----------|-------|-----------------|-------------------|-----------|
| Invite member | Admin user, valid email | 201 | `{ data: { invitation } }` | TR-040 |
| Duplicate invite | Email already invited | 409 | `{ error: { code: "DUPLICATE_EMAIL" } }` | TR-040 |
| Editor role | Editor attempts invite | 403 | `{ error: { code: "FORBIDDEN" } }` | TR-040 |

### 4.9 System Endpoints (1 total)

#### API: GET /api/health

| Scenario | Input | Expected Status | Expected Response | Traces To |
|----------|-------|-----------------|-------------------|-----------|
| Health check | No auth required | 200 | `{ status: "healthy", timestamp, database: "connected" }` | Deployment |
| DB disconnected | Database down | 503 | `{ status: "unhealthy", database: "disconnected" }` | Deployment |

---

## 5. UI Screen Test Requirements

### 5.1 Authentication Screens

#### Screen: LoginPage (/login)

| State | Condition | Expected Behavior | Traces To |
|-------|-----------|-------------------|-----------|
| Default | Page loads | Shows email, password fields, login button, "Forgot password?" link | TR-003 |
| Loading | Form submitted | Button disabled, shows loading spinner | TR-003 |
| Success | Valid credentials | Redirect to /dashboard | TR-003 |
| Error | Invalid credentials | Shows error message "Invalid email or password" | TR-004 |
| Rate limited | Too many attempts | Shows "Too many attempts. Please try again later." | TR-004 |

#### Screen: RegisterPage (/register)

| State | Condition | Expected Behavior | Traces To |
|-------|-----------|-------------------|-----------|
| Default | Page loads | Shows email, password, name fields, register button | TR-001 |
| Loading | Form submitted | Button disabled, shows loading spinner | TR-001 |
| Success | Valid registration | Redirect to /dashboard | TR-001 |
| Error | Duplicate email | Shows "Email already registered" | TR-002 |
| Validation | Weak password | Shows "Password must be at least 8 characters with 1 uppercase and 1 digit" | TR-002 |

#### Screen: ForgotPasswordPage (/forgot-password)

| State | Condition | Expected Behavior | Traces To |
|-------|-----------|-------------------|-----------|
| Default | Page loads | Shows email field, submit button | TR-005 |
| Success | Email submitted | Shows "Check your email for reset instructions" | TR-005 |
| Loading | Form submitted | Button disabled, shows loading spinner | TR-005 |

#### Screen: ResetPasswordPage (/reset-password)

| State | Condition | Expected Behavior | Traces To |
|-------|-----------|-------------------|-----------|
| Loading | Token validation | Shows loading spinner | TR-005 |
| Valid token | Token valid | Shows password, confirm password fields | TR-005 |
| Invalid token | Token expired/invalid | Shows "Invalid or expired reset link" | TR-005 |
| Success | Password reset | Shows "Password reset successful" and login button | TR-005 |
| Validation | Passwords don't match | Shows "Passwords must match" | TR-005 |

#### Screen: AcceptInvitePage (/accept-invite)

| State | Condition | Expected Behavior | Traces To |
|-------|-----------|-------------------|-----------|
| Loading | Token validation | Shows loading spinner | TR-007 |
| Valid invite | Token valid | Shows org name, inviter, role, name/password fields | TR-007 |
| Invalid token | Token expired/used | Shows "Invalid or expired invitation link" | TR-007 |
| Success | Invite accepted | Auto-login and redirect to /dashboard | TR-007 |
| Already used | Token already used | Shows "This invitation has already been accepted" | TR-007 |

### 5.2 Core Application Screens

#### Screen: DashboardPage (/dashboard)

| State | Condition | Expected Behavior | Traces To |
|-------|-----------|-------------------|-----------|
| Default | User has projects | Shows project cards in grid, sorted by updatedAt | TR-009 |
| Empty | No projects | Shows empty state with "Create your first project" CTA | TR-009 |
| Loading | Data fetching | Shows skeleton loading cards | TR-009 |
| Error | API fails | Shows error message with retry button | TR-009 |

#### Screen: ProjectDetailPage (/projects/:id)

| State | Condition | Expected Behavior | Traces To |
|-------|-----------|-------------------|-----------|
| Default | Project loaded | Shows project name, description, tabs: Overview, Data Sources, Jobs, Datasets | TR-011 |
| Loading | Data fetching | Shows skeleton loaders | TR-011 |
| Not found | Invalid projectId | Shows 404 error page | TR-011 |
| Forbidden | Project from other org | Shows 403 error message | TR-011 |
| Empty project | No data sources | Shows "Add your first data source" CTA | TR-011 |

#### Screen: DataSourceUploadPage (/projects/:id/upload)

| State | Condition | Expected Behavior | Traces To |
|-------|-----------|-------------------|-----------|
| Default | Page loads | Shows drag-and-drop zone, file picker button | TR-015 |
| Drag over | File dragged over zone | Zone highlights with border | TR-015 |
| Uploading | File upload in progress | Shows progress bar with percentage | TR-015 |
| Success | Upload complete | Shows success message, redirects to preview | TR-015 |
| Error | Upload fails | Shows error message with details | TR-015 |
| File too large | >100MB file | Shows "File exceeds 100MB limit" | TR-015 |

#### Screen: DataPreviewPage (/data-sources/:id/preview)

| State | Condition | Expected Behavior | Traces To |
|-------|-----------|-------------------|-----------|
| Default | Data loaded | Shows data table with first 100 rows | TR-017 |
| Loading | Data fetching | Shows table skeleton | TR-017 |
| Empty | No data | Shows "No data to preview" | TR-017 |
| Error | API fails | Shows error message with retry | TR-017 |

#### Screen: SchemaMappingPage (/projects/:id/schema)

| State | Condition | Expected Behavior | Traces To |
|-------|-----------|-------------------|-----------|
| Default | Page loads | Shows source columns on left, target schema on right | TR-021 |
| Mapping | Column dragged to field | Creates visual connection line | TR-021 |
| Configured | Mapping saved | Shows "Mapping saved" success message | TR-021 |
| PII tab | Switch to PII tab | Shows PII detection rules configuration | TR-022 |
| Validation | Required field unmapped | Shows "Required field must be mapped" error | TR-021 |

#### Screen: ProcessingJobPage (/jobs/:id)

| State | Condition | Expected Behavior | Traces To |
|-------|-----------|-------------------|-----------|
| Pending | Job queued | Shows "Waiting to start" message | TR-026 |
| Processing | Job running | Shows real-time progress bar, current stage, ETA | TR-027 |
| Completed | Job finished | Shows "Processing complete" with dataset link | TR-028 |
| Failed | Job error | Shows error message with logs link | TR-029 |
| Cancelled | Job cancelled | Shows "Job cancelled" status | TR-030 |

#### Screen: DatasetDetailPage (/datasets/:id)

| State | Condition | Expected Behavior | Traces To |
|-------|-----------|-------------------|-----------|
| Default | Dataset loaded | Shows statistics, schema, preview table | TR-033 |
| Preview | Viewing data | Shows first 100 rows in table | TR-034 |
| Download | Format selected | Shows download button for JSON, CSV, JSONL | TR-035 |
| Loading | Data fetching | Shows skeleton loaders | TR-033 |

### 5.3 Settings Screens

#### Screen: ProfilePage (/profile)

| State | Condition | Expected Behavior | Traces To |
|-------|-----------|-------------------|-----------|
| Default | Page loads | Shows user name, email, role, organization | TR-006 |
| Loading | Data fetching | Shows skeleton | TR-006 |

#### Screen: ProfileEditPage (/profile/edit)

| State | Condition | Expected Behavior | Traces To |
|-------|-----------|-------------------|-----------|
| Default | Page loads | Shows editable name, password change fields | TR-006 |
| Success | Profile updated | Shows "Profile updated successfully" | TR-006 |
| Password tab | Switch to password tab | Shows current password, new password, confirm fields | TR-006 |
| Validation | Wrong current password | Shows "Current password incorrect" | TR-006 |

#### Screen: TeamMembersPage (/team)

| State | Condition | Expected Behavior | Traces To |
|-------|-----------|-------------------|-----------|
| Default | Admin views page | Shows members table with name, email, role, actions | TR-039 |
| Forbidden | Non-admin views page | Redirects to /dashboard with error | TR-039 |
| Invite dialog | Click "Invite member" | Opens modal with email and role fields | TR-040 |
| Success | Member invited | Shows "Invitation sent" message | TR-040 |

#### Screen: OrganizationSettingsPage (/settings/organization)

| State | Condition | Expected Behavior | Traces To |
|-------|-----------|-------------------|-----------|
| Default | Admin views page | Shows org name (editable), slug (read-only), stats | TR-037 |
| Forbidden | Non-admin views page | Redirects to /dashboard with error | TR-037 |
| Success | Settings updated | Shows "Settings updated" message | TR-038 |

### 5.4 Error Screens

#### Screen: NotFoundPage (/404)

| State | Condition | Expected Behavior | Traces To |
|-------|-----------|-------------------|-----------|
| Default | Unknown route | Shows "Page not found" with link to dashboard | Error handling |

#### Screen: ErrorPage (/error)

| State | Condition | Expected Behavior | Traces To |
|-------|-----------|-------------------|-----------|
| Default | Unhandled error | Shows "Something went wrong" with retry button | Error handling |

---

## 6. Form Validation Test Requirements

### 6.1 Authentication Forms

#### Form: Register Form (RegisterPage)

| Field | Validation Rule | Valid Input | Invalid Input | Expected Error | Traces To |
|-------|-----------------|-------------|---------------|----------------|-----------|
| email | Required, email format | "user@example.com" | "not-an-email" | "Invalid email format" | TR-001 |
| email | Unique | New email | Existing email | "Email already registered" | TR-002 |
| password | Min 8 chars | "ValidPass1" | "short" | "Min 8 characters" | TR-001 |
| password | 1 uppercase | "ValidPass1" | "validpass1" | "Must contain 1 uppercase letter" | TR-001 |
| password | 1 digit | "ValidPass1" | "ValidPass" | "Must contain 1 digit" | TR-001 |
| name | Required, max 100 | "John Doe" | "" | "Name is required" | TR-001 |
| inviteToken | Valid UUID | Valid UUID | "bad-token" | "Invalid invitation token" | TR-007 |

#### Form: Login Form (LoginPage)

| Field | Validation Rule | Valid Input | Invalid Input | Expected Error | Traces To |
|-------|-----------------|-------------|---------------|----------------|-----------|
| email | Required, email format | "user@example.com" | "not-an-email" | "Invalid email format" | TR-003 |
| password | Required | "any-password" | "" | "Password is required" | TR-003 |

#### Form: Forgot Password Form (ForgotPasswordPage)

| Field | Validation Rule | Valid Input | Invalid Input | Expected Error | Traces To |
|-------|-----------------|-------------|---------------|----------------|-----------|
| email | Required, email format | "user@example.com" | "not-an-email" | "Invalid email format" | TR-005 |

#### Form: Reset Password Form (ResetPasswordPage)

| Field | Validation Rule | Valid Input | Invalid Input | Expected Error | Traces To |
|-------|-----------------|-------------|---------------|----------------|-----------|
| password | Min 8 chars, 1 upper, 1 digit | "NewPass1" | "short" | "Min 8 characters with 1 uppercase and 1 digit" | TR-005 |
| confirmPassword | Must match password | "NewPass1" | "Different1" | "Passwords must match" | TR-005 |

#### Form: Accept Invite Form (AcceptInvitePage)

| Field | Validation Rule | Valid Input | Invalid Input | Expected Error | Traces To |
|-------|-----------------|-------------|---------------|----------------|-----------|
| name | Required, max 100 | "Jane Smith" | "" | "Name is required" | TR-007 |
| password | Min 8 chars, 1 upper, 1 digit | "NewPass1" | "weak" | "Min 8 characters with 1 uppercase and 1 digit" | TR-007 |
| confirmPassword | Must match password | "NewPass1" | "Different1" | "Passwords must match" | TR-007 |

### 6.2 Project Forms

#### Form: Create Project Form (ProjectCreatePage)

| Field | Validation Rule | Valid Input | Invalid Input | Expected Error | Traces To |
|-------|-----------------|-------------|---------------|----------------|-----------|
| name | Required, max 200 | "Customer Support Project" | "" | "Name is required" | TR-010 |
| description | Optional, max 1000 | Any text up to 1000 chars | 1001+ chars | "Max 1000 characters" | TR-010 |

#### Form: Edit Project Form (ProjectEditPage)

| Field | Validation Rule | Valid Input | Invalid Input | Expected Error | Traces To |
|-------|-----------------|-------------|---------------|----------------|-----------|
| name | Required, max 200 | "Updated Project Name" | "" | "Name is required" | TR-012 |
| description | Optional, max 1000 | Any text | 1001+ chars | "Max 1000 characters" | TR-012 |

### 6.3 Profile Forms

#### Form: Edit Profile Form (ProfileEditPage)

| Field | Validation Rule | Valid Input | Invalid Input | Expected Error | Traces To |
|-------|-----------------|-------------|---------------|----------------|-----------|
| name | Required, max 100 | "Updated Name" | "" | "Name is required" | TR-006 |

#### Form: Change Password Form (ProfileEditPage)

| Field | Validation Rule | Valid Input | Invalid Input | Expected Error | Traces To |
|-------|-----------------|-------------|---------------|----------------|-----------|
| currentPassword | Required | Current password | Wrong password | "Current password incorrect" | TR-006 |
| newPassword | Min 8, 1 upper, 1 digit | "NewPass1" | "weak" | "Min 8 characters with 1 uppercase and 1 digit" | TR-006 |
| confirmPassword | Must match newPassword | "NewPass1" | "Different1" | "Passwords must match" | TR-006 |

### 6.4 Team Management Forms

#### Form: Invite Member Form (InviteMemberDialog)

| Field | Validation Rule | Valid Input | Invalid Input | Expected Error | Traces To |
|-------|-----------------|-------------|---------------|----------------|-----------|
| email | Required, email format, not existing | "newuser@example.com" | "not-email" | "Invalid email format" | TR-040 |
| email | Not already member | New email | Existing email | "User already a member" | TR-040 |
| role | Required, enum (admin, editor, viewer) | "editor" | "" | "Role is required" | TR-040 |

---

## 7. Environment Configuration

### 7.1 Environment Variables

| Variable | Type | Purpose | Default | Validation | Required For |
|----------|------|---------|---------|------------|--------------|
| NODE_ENV | REQUIRED_WITH_DEFAULT | Environment mode | development | production \| development \| test | All environments |
| PORT | REQUIRED_WITH_DEFAULT | Server port | 5000 | Integer 1-65535 | All environments |
| DATABASE_URL | REQUIRED | PostgreSQL connection | - | Valid PostgreSQL URL | All environments |
| JWT_SECRET | REQUIRED | Token signing key | - | Min 32 characters | All environments |
| JWT_EXPIRY | REQUIRED_WITH_DEFAULT | Token lifetime | 24h | Valid duration (e.g., 24h, 7d) | All environments |
| BCRYPT_ROUNDS | REQUIRED_WITH_DEFAULT | Password hashing cost | 12 | Integer 10-15 | All environments |
| ENCRYPTION_KEY | REQUIRED | OAuth token encryption | - | 32-byte hex string | All environments |
| S3_ENDPOINT | REQUIRED | S3-compatible endpoint | - | Valid URL | Production |
| S3_ACCESS_KEY_ID | REQUIRED | S3 access key | - | Valid key | Production |
| S3_SECRET_ACCESS_KEY | REQUIRED | S3 secret key | - | Valid secret | Production |
| S3_BUCKET_NAME | REQUIRED | S3 bucket | - | Valid bucket name | Production |
| S3_REGION | REQUIRED_WITH_DEFAULT | S3 region | auto | Valid region code | Production |
| RESEND_API_KEY | OPTIONAL | Email service key | - | Valid API key | Production (degrades gracefully) |
| RESEND_FROM_EMAIL | OPTIONAL | Sender email | - | Valid email | Production (required if RESEND_API_KEY set) |
| TEAMWORK_CLIENT_ID | OPTIONAL | OAuth client ID | - | Valid client ID | Production (if using Teamwork) |
| TEAMWORK_CLIENT_SECRET | OPTIONAL | OAuth client secret | - | Valid secret | Production (if using Teamwork) |
| TEAMWORK_REDIRECT_URI | OPTIONAL | OAuth callback URL | - | Valid URL | Production (if using Teamwork) |
| CORS_ORIGIN | REQUIRED_WITH_DEFAULT | Allowed CORS origins | * | Comma-separated URLs | Production |
| RATE_LIMIT_WINDOW_MS | REQUIRED_WITH_DEFAULT | Rate limit window | 60000 | Integer milliseconds | All environments |
| RATE_LIMIT_MAX_REQUESTS | REQUIRED_WITH_DEFAULT | Rate limit max | 100 | Integer | All environments |
| LOG_LEVEL | REQUIRED_WITH_DEFAULT | Logging verbosity | info | debug \| info \| warn \| error | All environments |

### 7.2 Environment Variable Classification

**REQUIRED Variables:**
- Must be set for application to start
- Application throws error and exits if missing
- No safe default value exists

**REQUIRED_WITH_DEFAULT Variables:**
- Has safe default value
- Application starts with default if not set
- Default documented and predictable

**OPTIONAL Variables:**
- Application functions without (feature degrades gracefully)
- Example: Email service - logs to console if not configured

### 7.3 Environment File Templates

#### .env.example (Development)

```bash
# Node Environment
NODE_ENV=development
PORT=5000

# Database (Replit PostgreSQL)
DATABASE_URL=postgresql://username:password@localhost:5432/foundry

# Authentication
JWT_SECRET=your-secret-key-min-32-characters-long
JWT_EXPIRY=24h
BCRYPT_ROUNDS=12
ENCRYPTION_KEY=your-32-byte-hex-encryption-key-here

# External Storage (S3-Compatible)
S3_ENDPOINT=https://your-r2-endpoint.r2.cloudflarestorage.com
S3_ACCESS_KEY_ID=your-access-key
S3_SECRET_ACCESS_KEY=your-secret-key
S3_BUCKET_NAME=foundry-dev
S3_REGION=auto

# Email Service (Optional - logs to console in dev)
# RESEND_API_KEY=re_your_api_key
# RESEND_FROM_EMAIL=noreply@foundry.dev

# OAuth Integration (Optional)
# TEAMWORK_CLIENT_ID=your-client-id
# TEAMWORK_CLIENT_SECRET=your-client-secret
# TEAMWORK_REDIRECT_URI=http://localhost:5000/api/oauth/teamwork/callback

# Security
CORS_ORIGIN=http://localhost:5173,http://localhost:5000
RATE_LIMIT_WINDOW_MS=60000
RATE_LIMIT_MAX_REQUESTS=100

# Logging
LOG_LEVEL=debug
```

#### .env.production (Production)

```bash
# Node Environment
NODE_ENV=production
PORT=5000

# Database (Replit PostgreSQL)
DATABASE_URL=${REPLIT_DATABASE_URL}

# Authentication
JWT_SECRET=${JWT_SECRET}
JWT_EXPIRY=24h
BCRYPT_ROUNDS=12
ENCRYPTION_KEY=${ENCRYPTION_KEY}

# External Storage
S3_ENDPOINT=${S3_ENDPOINT}
S3_ACCESS_KEY_ID=${S3_ACCESS_KEY_ID}
S3_SECRET_ACCESS_KEY=${S3_SECRET_ACCESS_KEY}
S3_BUCKET_NAME=foundry-prod
S3_REGION=auto

# Email Service (Required in production)
RESEND_API_KEY=${RESEND_API_KEY}
RESEND_FROM_EMAIL=noreply@foundry.dev

# OAuth Integration
TEAMWORK_CLIENT_ID=${TEAMWORK_CLIENT_ID}
TEAMWORK_CLIENT_SECRET=${TEAMWORK_CLIENT_SECRET}
TEAMWORK_REDIRECT_URI=https://your-app.replit.app/api/oauth/teamwork/callback

# Security
CORS_ORIGIN=https://your-app.replit.app
RATE_LIMIT_WINDOW_MS=60000
RATE_LIMIT_MAX_REQUESTS=100

# Logging
LOG_LEVEL=info
```

---

## 8. Deployment Specification

### 8.1 Replit Configuration

#### .replit File

```toml
run = "npm start"
entrypoint = "server/index.ts"

[nix]
channel = "stable-24_05"

[deployment]
run = ["sh", "-c", "npm run build && npm start"]
deploymentTarget = "cloudrun"

[[ports]]
localPort = 5000
externalPort = 80
```

**Verification Command:**
```bash
grep "localPort = 5000" .replit
```

**Expected Result:** Line present with port 5000

#### replit.nix File

```nix
{ pkgs }: {
  deps = [
    pkgs.nodejs-20_x
    pkgs.postgresql
  ];
}
```

**Verification Command:**
```bash
grep "nodejs-20_x" replit.nix
```

**Expected Result:** Node.js 20.x specified

#### drizzle.config.ts

```typescript
import { defineConfig } from 'drizzle-kit';

export default defineConfig({
  schema: './server/db/schema.ts',
  out: './server/db/migrations',
  dialect: 'postgresql',
  dbCredentials: {
    url: process.env.DATABASE_URL!,
  },
});
```

**Verification Command:**
```bash
grep "dialect: 'postgresql'" drizzle.config.ts
```

**Expected Result:** PostgreSQL dialect configured

#### package.json Scripts (Replit-Specific)

**Critical Scripts:**
```json
{
  "scripts": {
    "db:push": "drizzle-kit push --force",
    "db:generate": "drizzle-kit generate --force"
  }
}
```

**Verification Command:**
```bash
grep "\-\-force" package.json | grep -E "db:push|db:generate"
```

**Expected Result:** Both db:push and db:generate have --force flag

#### vite.config.ts (Replit Watch Configuration)

**CRITICAL - ALL FOUR WATCH SETTINGS REQUIRED:**

```typescript
export default defineConfig({
  server: {
    port: 5173,
    host: '0.0.0.0',
    watch: {
      usePolling: true,       // REQUIRED 1/4
      interval: 1000,         // REQUIRED 2/4
      ignored: [              // REQUIRED 3/4
        '**/node_modules/**',
        '**/.git/**',
        '**/dist/**'
      ]
    }
  }
});
```

**Verification Commands:**

```bash
# Check all 4 required settings
grep -E "usePolling|interval|ignored|host" vite.config.ts

# Verify usePolling
grep "usePolling: true" vite.config.ts

# Verify interval
grep "interval:" vite.config.ts

# Verify ignored array
grep -A 3 "ignored:" vite.config.ts

# Verify host/port
grep "host:" vite.config.ts
grep "port:" vite.config.ts
```

**Expected Results:**
- usePolling: true present
- interval: 1000 present
- ignored array with node_modules, .git, dist
- host: '0.0.0.0' or similar
- port: 5173

**AUDIT FIX (HIGH-010):** Missing any of these 4 settings causes deployment or performance issues. All 4 are mandatory.

#### Tailwind CSS v4 Configuration (client/src/index.css)

**CRITICAL - CORRECT SYNTAX:**

```css
@import "tailwindcss";

@layer base {
  :root {
    --background: 0 0% 100%;
    /* ... other CSS variables */
  }
}
```

**Verification Command:**
```bash
grep "@import \"tailwindcss\"" client/src/index.css
```

**Expected Result:** `@import "tailwindcss";` present (NOT `@tailwind` directives)

**DO NOT USE (v3 syntax - causes parsing errors):**
```css
@tailwind base;
@tailwind components;
@tailwind utilities;
```

**Verification Command for Errors:**
```bash
grep "@tailwind" client/src/index.css
```

**Expected Result:** No matches (if matches found, incorrect v3 syntax present)

#### postcss.config.js

```javascript
export default {
  plugins: {
    '@tailwindcss/postcss': {},
  },
};
```

**Verification Command:**
```bash
grep "@tailwindcss/postcss" postcss.config.js
```

**Expected Result:** Tailwind CSS v4 PostCSS plugin configured

### 8.2 Deployment Checklist

#### Pre-Deployment Verification

**1. Environment Variables**
- [ ] All REQUIRED variables present in Replit Secrets
- [ ] All REQUIRED variables validated (format, length)
- [ ] OPTIONAL variables configured or graceful degradation tested
- [ ] DATABASE_URL points to Replit PostgreSQL
- [ ] JWT_SECRET is min 32 characters
- [ ] ENCRYPTION_KEY is 32-byte hex string
- [ ] S3 credentials valid and tested
- [ ] RESEND_API_KEY valid (if set)

**2. Database**
- [ ] Drizzle schema matches Data Model specification
- [ ] Migration files generated (`npm run db:generate`)
- [ ] Migrations applied successfully (`npm run db:migrate` or `npm run db:push --force`)
- [ ] Connection pool configured (max 10 connections)
- [ ] Test connection: `psql $DATABASE_URL -c "SELECT 1"`
- [ ] Seed data loaded (optional, development only)

**3. Replit Configuration (CRITICAL)**
- [ ] Port 5000 configured in .replit file
- [ ] `--force` flags in db:push and db:generate scripts
- [ ] Vite watch configuration complete (ALL 4 settings):
  - [ ] usePolling: true
  - [ ] interval: 1000
  - [ ] ignored: node_modules, .git, dist
  - [ ] host: 0.0.0.0 (or appropriate)
- [ ] Tailwind CSS v4 syntax in index.css (`@import "tailwindcss"`)
- [ ] No v3 syntax (`@tailwind` directives) present
- [ ] PostCSS configured with @tailwindcss/postcss
- [ ] Static file serving configured in Express

**4. External Services**
- [ ] S3 bucket exists and accessible
- [ ] S3 CORS configured for uploads
- [ ] Resend domain verified (if using)
- [ ] Teamwork OAuth credentials valid (if using)
- [ ] Test email sending (or verify console fallback)
- [ ] Test S3 upload/download

**5. Application Build**
- [ ] TypeScript compiles without errors (`npm run type-check`)
- [ ] ESLint passes (`npm run lint`)
- [ ] Client builds successfully (`npm run client:build`)
- [ ] Server builds successfully (`npm run server:build`)
- [ ] dist/ directory contains compiled assets

#### Deployment Execution

**1. Deploy to Replit**
- [ ] Push code to repository
- [ ] Replit triggers deployment
- [ ] Build completes successfully
- [ ] Container starts without errors

**2. Health Check**
- [ ] GET /api/health returns 200
- [ ] Response format: `{ status: "healthy", timestamp: "...", database: "connected" }`
- [ ] Database connection confirmed

**Verification Command:**
```bash
curl https://your-app.replit.app/api/health
```

**Expected Response:**
```json
{
  "status": "healthy",
  "timestamp": "2026-01-21T12:00:00Z",
  "database": "connected"
}
```

**3. Smoke Tests**
- [ ] Frontend loads (https://your-app.replit.app)
- [ ] Login page accessible
- [ ] Can register new user
- [ ] Can login with test credentials
- [ ] Dashboard loads after login
- [ ] Can create project
- [ ] Can upload file (if S3 configured)

#### Post-Deployment Validation

**1. Rate Limiting Verification**
- [ ] Rate limit headers present in responses
- [ ] X-RateLimit-Limit header
- [ ] X-RateLimit-Remaining header
- [ ] X-RateLimit-Reset header

**Verification Command:**
```bash
curl -I https://your-app.replit.app/api/projects -H "Authorization: Bearer $TOKEN"
```

**Expected Headers:**
```
X-RateLimit-Limit: 100
X-RateLimit-Remaining: 99
X-RateLimit-Reset: 1705312800
```

**2. Response Envelope Verification**
- [ ] All success responses use `{ data }` envelope
- [ ] All paginated responses include `pagination` object
- [ ] All error responses use `{ error: { code, message } }` envelope

**Verification Command:**
```bash
# Check success response
curl https://your-app.replit.app/api/projects -H "Authorization: Bearer $TOKEN"

# Should return: { "data": [...], "pagination": {...} }
```

**3. Pagination Verification**
- [ ] All list endpoints return pagination metadata
- [ ] Pagination includes: page, pageSize, totalPages, totalCount
- [ ] hasMore field present for infinite scroll support

**Verification:**
```bash
curl "https://your-app.replit.app/api/projects?page=1&page_size=10" -H "Authorization: Bearer $TOKEN"
```

**Expected Pagination Object:**
```json
{
  "page": 1,
  "pageSize": 10,
  "totalPages": 3,
  "totalCount": 28
}
```

---

## 9. Production Verification Gates

### Gate 1: Replit Vite Configuration Verification (AUDIT FIX: HIGH-010)

**Requirement:** Complete Replit Vite configuration with ALL FOUR watch settings

**Verification Commands:**

```bash
# Gate 1.1: Check usePolling
grep "usePolling: true" vite.config.ts
# Expected: Line present

# Gate 1.2: Check interval
grep "interval:" vite.config.ts
# Expected: interval: 1000 or similar

# Gate 1.3: Check ignored array
grep -A 3 "ignored:" vite.config.ts | grep "node_modules"
# Expected: node_modules in ignored array

# Gate 1.4: Check host/port
grep "host:" vite.config.ts && grep "port:" vite.config.ts
# Expected: Both present (host: '0.0.0.0', port: 5173)
```

**Pass Criteria:** All 4 commands return expected results

**Failure Impact:** Deployment issues, file watching problems, performance degradation

### Gate 2: Endpoint Count Verification

**Requirement:** Implementation matches API Contract endpoint count exactly

**Verification Commands:**

```bash
# Count routes by method
echo "POST endpoints:"
grep -rh "router.post\|app.post" server/routes/ | wc -l

echo "GET endpoints:"
grep -rh "router.get\|app.get" server/routes/ | wc -l

echo "PATCH endpoints:"
grep -rh "router.patch\|app.patch" server/routes/ | wc -l

echo "DELETE endpoints:"
grep -rh "router.delete\|app.delete" server/routes/ | wc -l
```

**Expected Counts:**
| Method | Count |
|--------|-------|
| POST | 15 |
| GET | 20 |
| PATCH | 5 |
| DELETE | 3 |
| **Total** | **43** |

**Pass Criteria:** Counts match expected exactly

**Failure Impact:** API Contract violation, missing functionality

### Gate 3: Replit Configuration Flags

**Requirement:** Drizzle commands have --force flags for Replit compatibility

**Verification Commands:**

```bash
# Check db:push has --force
grep "db:push" package.json | grep "\-\-force"
# Expected: Line with --force present

# Check db:generate has --force (if used)
grep "db:generate" package.json | grep "\-\-force" || echo "WARN: db:generate may need --force"
# Expected: Line with --force present OR warning
```

**Pass Criteria:** Both commands have --force flag

**Failure Impact:** Drizzle operations fail in Replit environment

### Gate 4: Test File Existence

**Requirement:** Test files exist for all route modules

**Verification Commands:**

```bash
# Check for test files
for route in server/routes/*.ts; do
  test_file="${route%.ts}.test.ts"
  if [ ! -f "$test_file" ]; then
    echo "MISSING: $test_file"
  fi
done
```

**Pass Criteria:** All route modules have corresponding .test.ts files

**Failure Impact:** Incomplete test coverage, untested endpoints

### Gate 5: CSS Framework Version Alignment (AUDIT FIX: CRIT-001)

**Requirement:** Tailwind CSS v4 specified and correct syntax used

**Verification Commands:**

```bash
# Check package.json for Tailwind v4
grep "\"tailwindcss\": \"\\^4" client/package.json
# Expected: Version 4.x specified

# Check for correct import syntax
grep "@import \"tailwindcss\"" client/src/index.css
# Expected: Line present

# Check for incorrect v3 syntax
grep "@tailwind" client/src/index.css
# Expected: No matches (error if found)
```

**Pass Criteria:**
- Tailwind CSS v4.x in package.json
- `@import "tailwindcss";` present in index.css
- No `@tailwind` directives present

**Failure Impact:** CSS parsing errors, build failures, styling issues

---

## 10. Frontend Completeness Verification (MANDATORY)

### 10.1 Page Implementation Verification

**Requirement:** All pages in UI Specification Page Inventory are implemented

**Verification Commands:**

```bash
# Count pages defined in UI spec
page_count=$(grep -E "^#### Screen: |^- \[ \].*Page -" docs/05-UI-UX-SPECIFICATION.md | wc -l)

# Count page files implemented
file_count=$(find client/src/pages -name "*.tsx" | wc -l)

echo "UI Spec Pages: $page_count"
echo "Implemented Pages: $file_count"
```

**Expected Result:** Counts match (21 pages)

**Manual Checklist:**

**Phase 1 - Auth (DEPLOYMENT BLOCKER):**
- [ ] client/src/pages/LoginPage.tsx
- [ ] client/src/pages/RegisterPage.tsx
- [ ] client/src/pages/ForgotPasswordPage.tsx
- [ ] client/src/pages/ResetPasswordPage.tsx
- [ ] client/src/pages/AcceptInvitePage.tsx ← **COMMONLY MISSED**

**Phase 2 - Core Flow (MVP BLOCKER):**
- [ ] client/src/pages/DashboardPage.tsx
- [ ] client/src/pages/ProjectDetailPage.tsx
- [ ] client/src/pages/DataSourceUploadPage.tsx
- [ ] client/src/pages/DataPreviewPage.tsx
- [ ] client/src/pages/SchemaMappingPage.tsx
- [ ] client/src/pages/ProcessingJobPage.tsx
- [ ] client/src/pages/DatasetDetailPage.tsx

**Phase 3 - Features (MVP BLOCKER):**
- [ ] client/src/pages/ProjectCreatePage.tsx
- [ ] client/src/pages/ProjectEditPage.tsx
- [ ] client/src/pages/OAuthConnectPage.tsx

**Phase 4 - Settings (SHOULD HAVE):**
- [ ] client/src/pages/ProfilePage.tsx
- [ ] client/src/pages/ProfileEditPage.tsx

**Phase 5 - Admin (IF ADMIN ROLE EXISTS):**
- [ ] client/src/pages/TeamMembersPage.tsx
- [ ] client/src/pages/OrganizationSettingsPage.tsx

**Phase 6 - Error Handling (MUST HAVE):**
- [ ] client/src/pages/ErrorPage.tsx
- [ ] client/src/pages/NotFoundPage.tsx

### 10.2 Route-to-Page Validation

**Requirement:** Every `<Route path="...">` in App.tsx has corresponding page file

**Verification Commands:**

```bash
# Extract routes from App.tsx
routes=$(grep -o 'path="[^"]*"' client/src/App.tsx | sed 's/path="//;s/"$//')

# Check each route has page file
for route in $routes; do
  # Convert route to page name (e.g., /login → LoginPage)
  page=$(echo "$route" | sed 's|^/||; s|/:.*||; s|-(.*)//g; s|^|/projects/:id/upload → DataSourceUploadPage|')
  
  if [ ! -f "client/src/pages/${page}.tsx" ]; then
    echo "ERROR: Route $route has no page file (expected: ${page}.tsx)"
  fi
done
```

**Expected Result:** No errors (all routes have pages)

### 10.3 Link-to-Route Validation

**Requirement:** Every `<Link to="...">` has corresponding `<Route path="...">`

**Verification Commands:**

```bash
# Extract all Link destinations
links=$(grep -roh 'to="[^"]*"' client/src | sed 's/to="//;s/"$//' | sort -u)

# Check each link has route
for link in $links; do
  if ! grep -q "path=\"$link\"" client/src/App.tsx; then
    echo "ERROR: Link to='$link' has no matching route"
  fi
done
```

**Expected Result:** No orphaned links (all Links have Routes)

### 10.4 ErrorBoundary Verification

**Requirement:** ErrorBoundary wraps application in App.tsx

**Verification Command:**

```bash
grep -n "ErrorBoundary" client/src/App.tsx
```

**Expected Result:** ErrorBoundary component present and wrapping Routes

**Example:**
```tsx
<ErrorBoundary>
  <Routes>
    {/* routes here */}
  </Routes>
</ErrorBoundary>
```

---

## 11. Test Coverage Matrix

### 11.1 Coverage by Source

| Spec Source | Total Items | Test Requirements | Coverage Status |
|-------------|-------------|-------------------|-----------------|
| PRD User Stories | 38 | 42 (TR-001 to TR-042) | ✓ 100% |
| API Endpoints | 43 | 43 scenarios | ✓ 100% |
| UI Pages | 21 | 21 screen tests | ✓ 100% |
| Forms | 15 | 15 form validations | ✓ 100% |
| Data Tables | 10 | Covered in integration tests | ✓ 100% |

### 11.2 Traceability Matrix (Sample)

| Spec Source | Spec Item | Test Requirement | Type | Status |
|-------------|-----------|------------------|------|--------|
| PRD US-001 | User registration | TR-001, TR-002 | Integration + E2E | ✓ |
| PRD US-002 | User login | TR-003, TR-004 | Integration + E2E | ✓ |
| API POST /api/auth/register | Register endpoint | TR-001, TR-002 | Integration | ✓ |
| API POST /api/auth/login | Login endpoint | TR-003, TR-004 | Integration | ✓ |
| UI RegisterPage | Registration screen | TR-001, TR-002 | E2E | ✓ |
| UI LoginPage | Login screen | TR-003, TR-004 | E2E | ✓ |
| PRD US-007 | Create project | TR-010 | Integration + E2E | ✓ |
| API POST /api/projects | Create project endpoint | TR-010 | Integration | ✓ |
| UI ProjectCreatePage | Create project screen | TR-010 | E2E | ✓ |

### 11.3 Coverage Metrics

| Category | Covered | Total | Percentage |
|----------|---------|-------|------------|
| User Stories | 38 | 38 | 100% |
| Acceptance Criteria | ~120 | ~120 | 100% |
| API Endpoints | 43 | 43 | 100% |
| API Response Codes | ~200 | ~200 | 100% |
| UI Screens | 21 | 21 | 100% |
| UI States | ~100 | ~100 | 100% |
| Forms | 15 | 15 | 100% |
| Form Fields | ~60 | ~60 | 100% |
| Validation Rules | ~80 | ~80 | 100% |

**Target:** 100% coverage across all categories

---

## 12. Appendix: Test Data Fixtures

### 12.1 Test Users

Create these users via seed script for testing:

```typescript
const testUsers = [
  {
    email: 'admin@test.foundry.dev',
    password: 'AdminTest123!',
    name: 'Test Admin',
    role: 'admin',
    organisation: 'test-org'
  },
  {
    email: 'editor@test.foundry.dev',
    password: 'EditorTest123!',
    name: 'Test Editor',
    role: 'editor',
    organisation: 'test-org'
  },
  {
    email: 'viewer@test.foundry.dev',
    password: 'ViewerTest123!',
    name: 'Test Viewer',
    role: 'viewer',
    organisation: 'test-org'
  }
];
```

### 12.2 Test Organization

```typescript
const testOrganisation = {
  id: 1,
  name: 'Test Organization',
  slug: 'test-org',
  createdAt: new Date('2026-01-01T00:00:00Z')
};
```

### 12.3 Test Project

```typescript
const testProject = {
  id: 1,
  name: 'Test Project',
  description: 'Project for automated testing',
  status: 'active',
  organisationId: 1,
  createdById: 1, // admin user
  createdAt: new Date('2026-01-01T00:00:00Z')
};
```

### 12.4 Test CSV File (conversations-test.csv)

```csv
message_id,role,message_text,timestamp,thread_id
1,customer,How do I reset my password?,2026-01-15T10:00:00Z,thread-001
2,agent,You can reset your password by clicking the "Forgot Password" link on the login page.,2026-01-15T10:02:00Z,thread-001
3,customer,Thank you!,2026-01-15T10:03:00Z,thread-001
4,customer,I'm having trouble logging in,2026-01-16T14:30:00Z,thread-002
5,agent,What error message are you seeing?,2026-01-16T14:32:00Z,thread-002
```

### 12.5 Test JSON File (conversations-test.json)

```json
[
  {
    "message_id": 1,
    "role": "customer",
    "message_text": "How do I reset my password?",
    "timestamp": "2026-01-15T10:00:00Z",
    "thread_id": "thread-001",
    "metadata": {
      "channel": "email",
      "sentiment": "neutral"
    }
  },
  {
    "message_id": 2,
    "role": "agent",
    "message_text": "You can reset your password by clicking the 'Forgot Password' link.",
    "timestamp": "2026-01-15T10:02:00Z",
    "thread_id": "thread-001",
    "metadata": {
      "agent_id": "agent-123",
      "response_time_seconds": 120
    }
  }
]
```

---

## ASSUMPTION REGISTER

### AR-QA-001: Test Automation Framework

- **Type:** ASSUMPTION
- **Source Gap:** Implementation Plan doesn't specify test runner/framework
- **Assumption Made:** Vitest for unit/integration tests, Playwright for E2E, Testing Library for component tests
- **Impact if Wrong:** Need to rewrite test specifications for different framework
- **Proposed Resolution:** Confirm test framework choices with implementation team
- **Status:** UNRESOLVED
- **Owner:** Agent 6 (Implementation) or Human
- **Date:** 2026-01-21

### AR-QA-002: Test Data Reset Strategy

- **Type:** ASSUMPTION
- **Source Gap:** How test database is reset between test runs not specified
- **Assumption Made:** Test suite uses beforeEach hooks to seed fresh test data, transactions rollback after each test
- **Impact if Wrong:** Test pollution, flaky tests due to shared state
- **Proposed Resolution:** Define test database reset strategy in implementation
- **Status:** UNRESOLVED
- **Owner:** Agent 6 (Implementation)
- **Date:** 2026-01-21

### AR-QA-003: S3 Mocking in Tests

- **Type:** ASSUMPTION
- **Source Gap:** How to mock S3 operations in test environment
- **Assumption Made:** Use MinIO or aws-sdk-mock for S3 operations in tests, avoid hitting real S3 in CI
- **Impact if Wrong:** Tests require real S3 access, slow and brittle tests
- **Proposed Resolution:** Specify S3 mocking strategy (MinIO, aws-sdk-mock, or custom)
- **Status:** UNRESOLVED
- **Owner:** Agent 6 (Implementation)
- **Date:** 2026-01-21

### AR-QA-004: Email Service Mocking

- **Type:** ASSUMPTION
- **Source Gap:** How to verify emails sent in tests without actually sending
- **Assumption Made:** Email service returns mock in test environment, assertions on captured email objects
- **Impact if Wrong:** Tests actually send emails, or cannot verify email content
- **Proposed Resolution:** Specify email mocking strategy (Resend test mode, mock service, or spy)
- **Status:** UNRESOLVED
- **Owner:** Agent 6 (Implementation)
- **Date:** 2026-01-21

### AR-QA-005: Continuous Integration Setup

- **Type:** DEPENDENCY
- **Source Gap:** CI/CD pipeline configuration not specified
- **Assumption Made:** Tests run in GitHub Actions or similar CI, includes linting, type checking, and all test suites
- **Impact if Wrong:** No automated testing, manual verification required
- **Proposed Resolution:** Define CI/CD pipeline in implementation plan
- **Status:** UNRESOLVED
- **Owner:** Human (DevOps) or Agent 6
- **Date:** 2026-01-21

---

## Document Validation

### Completeness Checklist

- [x] Test requirements for all 38 user stories
- [x] Test scenarios for all 43 API endpoints
- [x] Test scenarios for all 21 UI screens
- [x] Test scenarios for all 15 forms
- [x] Environment configuration documented (19 variables)
- [x] Deployment checklist complete (5 phases)
- [x] Post-deployment validation complete (3 gates)
- [x] All 5 production verification gates included
- [x] Complete Replit Vite configuration verification (all 4 watch settings)
- [x] Test coverage matrix complete (100% coverage)
- [x] Traceability verified (all specs → test requirements)

### Audit Prevention Summary

This QA & Deployment Specification addresses 2 common production issues:
- **HIGH-010**: Complete Replit Vite Configuration Checklist with all 4 watch settings (usePolling, interval, ignored, host/port)
- **CRIT-001**: CSS Framework Version Alignment - Tailwind CSS v4 syntax verification

### Prompt Hygiene Gate (Constitution Section L)

- [x] Framework Version header present and correct
- [x] Encoding scan: No non-ASCII artifact tokens
- [x] Inheritance references Constitution v3.3
- [x] No full global rule restatements

### Coverage Metrics

| Category | Covered | Total | Percentage |
|----------|---------|-------|------------|
| User Stories | 38 | 38 | 100% |
| API Endpoints | 43 | 43 | 100% |
| UI Screens | 21 | 21 | 100% |
| Forms | 15 | 15 | 100% |

**Target:** 100% coverage across all categories ✓ ACHIEVED

### Document Status: COMPLETE

---

## Downstream Agent Handoff Brief

### For Agent 8: Code Review (if exists)

**Test Implementation Verification:**
- Verify test files exist for all routes (Gate 4)
- Verify test coverage meets 100% requirement
- Verify test data fixtures match specification
- Verify test users and organizations seeded correctly

**Code Quality Verification:**
- Run all 5 production verification gates
- **CRITICAL:** Run complete Vite configuration check (Gate 1) - all 4 watch settings
- Verify no forbidden patterns
- Verify validation specs match API Contract exactly
- Verify response envelopes use helpers (sendSuccess, sendError)
- Verify rate limiting applied to all endpoints

**Replit Configuration Critical Items:**
- vite.config.ts MUST have all 4 watch settings (usePolling, interval, ignored, host/port)
- package.json MUST have --force flags on db:push and db:generate
- client/src/index.css MUST use `@import "tailwindcss"` (NOT `@tailwind` directives)
- .env.example MUST classify variables (REQUIRED, REQUIRED_WITH_DEFAULT, OPTIONAL)
- .replit MUST specify port 5000

**Deployment Readiness:**
- All environment variables documented
- Replit configuration complete (verified via automated checks)
- Health check endpoint responds correctly
- Post-deployment validation passes all gates
- Frontend page count matches spec (21 pages)
- API endpoint count matches spec (43 endpoints)

**Test Requirements Summary:**
- 42 test requirements (TR-001 to TR-042)
- 43 API endpoint scenarios
- 21 UI screen tests
- 15 form validation tests
- 100% traceability to PRD user stories

---

## Document End
