# Implementation Plan: Foundry
**Generated by:** Agent 6 - Implementation Orchestrator v27 (Application-Agnostic)  
**Date:** 2026-01-21  
**Status:** Complete  
**Framework Version:** Agent Specification Framework v2.1  
**Constitution:** Agent 0 - Agent Constitution v3.3

---

## Document Purpose

This implementation plan provides the complete development roadmap for Foundry, transforming specifications into an ordered task list with scaffolding, starter code, and verification gates. Every task is sized 1-4 hours, explicitly ordered by dependencies, with clear acceptance criteria.

---

## 1. Implementation Overview

### 1.1 Project Summary

**Application:** Foundry - Multi-tenant SaaS platform for preparing AI-ready datasets  
**Tech Stack:** React 18 + TypeScript + Express.js + PostgreSQL + Drizzle ORM  
**Deployment:** Replit (port 5000)  
**Database:** PostgreSQL with Drizzle ORM (postgres-js driver)  
**UI Framework:** shadcn/ui + Tailwind CSS v4  
**External Services:** S3-compatible storage, Resend (email), Teamwork Desk OAuth

### 1.2 Upstream Documents

| Document | Agent | Version | Status |
|----------|-------|---------|--------|
| PRD | Agent 1 | v17 | Complete |
| Architecture | Agent 2 | v19 | Complete |
| Data Model | Agent 3 | v18 | Complete |
| API Contract | Agent 4 | v22 | Complete |
| UI/UX Specification | Agent 5 | v23 | Complete |

### 1.3 Implementation Metrics

| Metric | Count | Notes |
|--------|-------|-------|
| **Total Endpoints** | 43 | Per API Contract Section 4.1 |
| **Total Pages** | 21 | Per UI/UX Section 3.3 |
| **Database Tables** | 10 | Per Data Model Section 6 |
| **Mandatory Files** | 6 | Full code required (see Section 2) |
| **Total Tasks** | 87 | Sized 1-4 hours each |
| **Estimated Timeline** | 8-12 weeks | With 1-2 developers |

### 1.4 Critical Requirements

**MANDATORY Files (Full Code Required):**
1. `server/lib/validation.ts` - Parameter parsing helpers (prevents NaN database errors)
2. `server/lib/response.ts` - Response envelope helpers (consistent API responses)
3. `server/errors/index.ts` - Error class hierarchy (proper 4xx/5xx handling)
4. `server/middleware/error-handler.ts` - Global error handler (prevents crashes)
5. `client/src/components/error-boundary.tsx` - React error boundary (prevents blank screens)
6. `server/db/index.ts` - Database connection (correct postgres-js driver)

**Replit-Specific Requirements:**
- Port 5000 (not 3000)
- `--force` flag for db:push and db:migrate
- Vite watch config: `watch.ignored` for node_modules, .git, dist
- Trust proxy enabled for rate limiting

**CSS Framework Version Alignment (AUDIT FIX: CRIT-001):**
- Tailwind CSS v4 specified in package.json
- CSS import: `@import "tailwindcss";` (NOT `@tailwind` directives)
- Verification step in SETUP tasks

---

## 2. Project Scaffolding

### 2.1 Directory Structure

```
foundry/
├── client/                      # Frontend React application
│   ├── src/
│   │   ├── components/          # Reusable components
│   │   │   ├── ui/              # shadcn/ui components
│   │   │   ├── layout/          # Layout components
│   │   │   ├── forms/           # Form components
│   │   │   └── error-boundary.tsx  # [MANDATORY FULL CODE]
│   │   ├── pages/               # Page components (21 total)
│   │   ├── hooks/               # Custom React hooks
│   │   ├── lib/                 # Client utilities
│   │   │   ├── api.ts           # API client
│   │   │   └── auth.ts          # Auth helpers
│   │   ├── types/               # TypeScript types
│   │   ├── App.tsx              # Root component with routing
│   │   ├── main.tsx             # Entry point
│   │   ├── index.css            # Tailwind v4 imports [CRITICAL]
│   │   └── vite-env.d.ts        # Vite types
│   ├── public/                  # Static assets
│   ├── index.html               # HTML entry point
│   ├── vite.config.ts           # Vite configuration
│   ├── tailwind.config.js       # Tailwind v4 config
│   ├── postcss.config.js        # PostCSS with Tailwind v4
│   ├── tsconfig.json            # TypeScript config
│   ├── tsconfig.node.json       # TypeScript for Vite
│   └── package.json             # Frontend dependencies
├── server/                      # Backend Express application
│   ├── db/                      # Database layer
│   │   ├── schema.ts            # Drizzle schema (10 tables)
│   │   ├── index.ts             # [MANDATORY FULL CODE] DB connection
│   │   ├── migrate.ts           # Migration runner
│   │   ├── seed.ts              # Seed script
│   │   └── migrations/          # Generated migrations
│   ├── routes/                  # API route handlers (43 endpoints)
│   │   ├── auth.ts              # 8 auth endpoints
│   │   ├── projects.ts          # 6 project endpoints
│   │   ├── data-sources.ts      # 6 data source endpoints
│   │   ├── schema-mappings.ts   # 5 schema mapping endpoints
│   │   ├── processing-jobs.ts   # 6 processing job endpoints
│   │   ├── datasets.ts          # 4 dataset endpoints
│   │   ├── oauth.ts             # 3 OAuth endpoints
│   │   └── organisations.ts     # 4 organisation endpoints
│   ├── middleware/              # Express middleware
│   │   ├── auth.ts              # Authentication middleware
│   │   ├── error-handler.ts     # [MANDATORY FULL CODE] Global error handler
│   │   ├── rate-limit.ts        # Rate limiting config
│   │   └── validation.ts        # Request validation middleware
│   ├── services/                # Business logic layer
│   │   ├── auth.service.ts      # Auth operations
│   │   ├── project.service.ts   # Project operations
│   │   ├── processing.service.ts # Processing operations
│   │   ├── email.service.ts     # Email operations (OPTIONAL)
│   │   └── storage.service.ts   # S3 operations (REQUIRED)
│   ├── lib/                     # Server utilities
│   │   ├── validation.ts        # [MANDATORY FULL CODE] parseIntParam, pagination
│   │   ├── response.ts          # [MANDATORY FULL CODE] sendSuccess, sendError
│   │   ├── encryption.ts        # [MANDATORY FULL CODE] encrypt/decrypt for OAuth tokens
│   │   ├── pii.ts               # PII detection (compromise.js + regex)
│   │   ├── password.ts          # bcrypt helpers
│   │   └── tokens.ts            # JWT helpers
│   ├── errors/                  # Error handling
│   │   └── index.ts             # [MANDATORY FULL CODE] AppError hierarchy
│   ├── config/                  # Configuration
│   │   └── env.ts               # Environment variables
│   ├── index.ts                 # Express server entry point
│   └── package.json             # Backend dependencies
├── shared/                      # Shared code (types, validators)
│   ├── types.ts                 # Common TypeScript types
│   └── validators.ts            # Zod schemas
├── .replit                      # Replit configuration
├── replit.nix                   # Nix packages
├── .env.example                 # Environment template
├── drizzle.config.ts            # Drizzle ORM configuration
├── package.json                 # Root workspace config
├── tsconfig.json                # Root TypeScript config
└── README.md                    # Project documentation
```

### 2.2 Configuration Files

#### package.json (Root)

```json
{
  "name": "foundry",
  "version": "1.0.0",
  "private": true,
  "type": "module",
  "scripts": {
    "dev": "concurrently \"npm run server:dev\" \"npm run client:dev\"",
    "build": "npm run client:build && npm run server:build",
    "start": "node dist/server/index.js",
    "server:dev": "tsx watch server/index.ts",
    "server:build": "tsc -p server/tsconfig.json",
    "client:dev": "vite",
    "client:build": "vite build",
    "client:preview": "vite preview",
    "db:generate": "drizzle-kit generate",
    "db:migrate": "tsx server/db/migrate.ts",
    "db:push": "drizzle-kit push --force",
    "db:studio": "drizzle-kit studio",
    "db:seed": "tsx server/db/seed.ts",
    "lint": "eslint . --ext .ts,.tsx",
    "type-check": "tsc --noEmit"
  },
  "dependencies": {
    "@aws-sdk/client-s3": "^3.621.0",
    "@aws-sdk/s3-request-presigner": "^3.621.0",
    "bcryptjs": "^2.4.3",
    "compromise": "^14.13.0",
    "cors": "^2.8.5",
    "dotenv": "^16.4.5",
    "drizzle-orm": "^0.33.0",
    "express": "^4.21.1",
    "express-rate-limit": "^7.4.1",
    "helmet": "^8.0.0",
    "jsonwebtoken": "^9.0.2",
    "multer": "^1.4.5-lts.1",
    "postgres": "^3.4.4",
    "resend": "^4.0.0",
    "zod": "^3.23.8"
  },
  "devDependencies": {
    "@types/bcryptjs": "^2.4.6",
    "@types/cors": "^2.8.17",
    "@types/express": "^4.17.21",
    "@types/jsonwebtoken": "^9.0.7",
    "@types/multer": "^1.4.12",
    "@types/node": "^22.9.0",
    "@types/react": "^18.3.12",
    "@types/react-dom": "^18.3.1",
    "@typescript-eslint/eslint-plugin": "^8.14.0",
    "@typescript-eslint/parser": "^8.14.0",
    "@vitejs/plugin-react": "^4.3.3",
    "concurrently": "^9.1.0",
    "drizzle-kit": "^0.24.2",
    "eslint": "^9.14.0",
    "tsx": "^4.19.2",
    "typescript": "^5.6.3",
    "vite": "^5.4.11"
  },
  "engines": {
    "node": ">=20.0.0"
  }
}
```

**Known Good Versions (as of 2026-01-21):**
- express: 4.21.x
- postgres: 3.4.x
- drizzle-orm: 0.33.x
- react: 18.3.x
- vite: 5.4.x

#### client/package.json

```json
{
  "name": "foundry-client",
  "version": "1.0.0",
  "private": true,
  "type": "module",
  "scripts": {
    "dev": "vite",
    "build": "tsc && vite build",
    "preview": "vite preview"
  },
  "dependencies": {
    "@radix-ui/react-dialog": "^1.1.2",
    "@radix-ui/react-dropdown-menu": "^2.1.2",
    "@radix-ui/react-label": "^2.1.0",
    "@radix-ui/react-select": "^2.1.2",
    "@radix-ui/react-tabs": "^1.1.1",
    "@radix-ui/react-toast": "^1.2.2",
    "@tanstack/react-query": "^5.59.20",
    "class-variance-authority": "^0.7.0",
    "clsx": "^2.1.1",
    "lucide-react": "^0.454.0",
    "react": "^18.3.1",
    "react-dom": "^18.3.1",
    "react-router-dom": "^6.27.0",
    "tailwind-merge": "^2.5.4",
    "zod": "^3.23.8"
  },
  "devDependencies": {
    "@types/react": "^18.3.12",
    "@types/react-dom": "^18.3.1",
    "@vitejs/plugin-react": "^4.3.3",
    "tailwindcss": "^4.0.0",
    "@tailwindcss/postcss": "^4.0.0",
    "autoprefixer": "^10.4.20",
    "typescript": "^5.6.3",
    "vite": "^5.4.11"
  }
}
```

#### vite.config.ts

```typescript
import { defineConfig } from 'vite';
import react from '@vitejs/plugin-react';
import path from 'path';

export default defineConfig({
  plugins: [react()],
  resolve: {
    alias: {
      '@': path.resolve(__dirname, './client/src'),
    },
  },
  server: {
    port: 5173,
    proxy: {
      '/api': {
        target: 'http://localhost:5000',
        changeOrigin: true,
      },
    },
    watch: {
      // Replit-specific: Ignore directories to prevent excessive file watching
      ignored: ['**/node_modules/**', '**/.git/**', '**/dist/**'],
      usePolling: true, // Replit requires polling
      interval: 1000,
    },
  },
  build: {
    outDir: 'dist/public',
    emptyOutDir: true,
  },
});
```

#### client/src/index.css (CRITICAL - Tailwind v4 Syntax)

```css
@import "tailwindcss";

@layer base {
  :root {
    --background: 0 0% 100%;
    --foreground: 222.2 84% 4.9%;
    
    --card: 0 0% 100%;
    --card-foreground: 222.2 84% 4.9%;
    
    --popover: 0 0% 100%;
    --popover-foreground: 222.2 84% 4.9%;
    
    --primary: 222.2 47.4% 11.2%;
    --primary-foreground: 210 40% 98%;
    
    --secondary: 210 40% 96.1%;
    --secondary-foreground: 222.2 47.4% 11.2%;
    
    --muted: 210 40% 96.1%;
    --muted-foreground: 215.4 16.3% 46.9%;
    
    --accent: 210 40% 96.1%;
    --accent-foreground: 222.2 47.4% 11.2%;
    
    --destructive: 0 84.2% 60.2%;
    --destructive-foreground: 210 40% 98%;
    
    --border: 214.3 31.8% 91.4%;
    --input: 214.3 31.8% 91.4%;
    --ring: 222.2 84% 4.9%;
    
    --radius: 0.5rem;
  }
  
  .dark {
    --background: 222.2 84% 4.9%;
    --foreground: 210 40% 98%;
    
    --card: 222.2 84% 4.9%;
    --card-foreground: 210 40% 98%;
    
    --popover: 222.2 84% 4.9%;
    --popover-foreground: 210 40% 98%;
    
    --primary: 210 40% 98%;
    --primary-foreground: 222.2 47.4% 11.2%;
    
    --secondary: 217.2 32.6% 17.5%;
    --secondary-foreground: 210 40% 98%;
    
    --muted: 217.2 32.6% 17.5%;
    --muted-foreground: 215 20.2% 65.1%;
    
    --accent: 217.2 32.6% 17.5%;
    --accent-foreground: 210 40% 98%;
    
    --destructive: 0 62.8% 30.6%;
    --destructive-foreground: 210 40% 98%;
    
    --border: 217.2 32.6% 17.5%;
    --input: 217.2 32.6% 17.5%;
    --ring: 212.7 26.8% 83.9%;
  }
}

@layer base {
  * {
    @apply border-border;
  }
  body {
    @apply bg-background text-foreground;
  }
}
```

#### postcss.config.js (Tailwind v4)

```javascript
export default {
  plugins: {
    '@tailwindcss/postcss': {},
  },
};
```

#### tailwind.config.js (Tailwind v4)

```javascript
/** @type {import('tailwindcss').Config} */
export default {
  content: [
    './client/index.html',
    './client/src/**/*.{js,ts,jsx,tsx}',
  ],
};
```

#### drizzle.config.ts

```typescript
import type { Config } from 'drizzle-kit';
import * as dotenv from 'dotenv';

dotenv.config();

export default {
  schema: './server/db/schema.ts',
  out: './server/db/migrations',
  dialect: 'postgresql',
  dbCredentials: {
    url: process.env.DATABASE_URL!,
  },
} satisfies Config;
```

#### .replit

```toml
run = "npm run dev"
language = "nodejs"

[nix]
channel = "stable-23_11"

[deployment]
deploymentTarget = "cloudrun"
run = "npm start"

[[ports]]
localPort = 5000
externalPort = 80
```

#### replit.nix

```nix
{ pkgs }: {
  deps = [
    pkgs.nodejs-20_x
    pkgs.postgresql
  ];
}
```

#### .env.example

```bash
# Database (REQUIRED)
DATABASE_URL=postgresql://user:password@host:5432/foundry

# JWT Authentication (REQUIRED)
JWT_SECRET=your-secret-key-min-32-chars-change-in-production

# Encryption for OAuth Tokens (REQUIRED)
# Generate: node -e "console.log(require('crypto').randomBytes(32).toString('hex'))"
ENCRYPTION_KEY=64-character-hex-string-exactly

# AWS S3 Storage (REQUIRED)
AWS_REGION=us-east-1
AWS_ACCESS_KEY_ID=your-access-key
AWS_SECRET_ACCESS_KEY=your-secret-key
AWS_S3_BUCKET=foundry-uploads
# For Cloudflare R2 or Backblaze B2, override endpoint:
# AWS_ENDPOINT=https://account.r2.cloudflarestorage.com

# Email Service (OPTIONAL - degrades gracefully)
RESEND_API_KEY=re_xxxxxxxxxxxxx
EMAIL_FROM=noreply@foundry.example.com

# Teamwork Desk OAuth (REQUIRED for OAuth feature)
TEAMWORK_DESK_CLIENT_ID=your-client-id
TEAMWORK_DESK_CLIENT_SECRET=your-client-secret
TEAMWORK_DESK_REDIRECT_URI=https://your-app.replit.app/api/oauth/callback

# Node Environment
NODE_ENV=development
PORT=5000
```

#### tsconfig.json (Root)

```json
{
  "compilerOptions": {
    "target": "ES2022",
    "module": "ESNext",
    "lib": ["ES2022"],
    "moduleResolution": "bundler",
    "strict": true,
    "esModuleInterop": true,
    "skipLibCheck": true,
    "forceConsistentCasingInFileNames": true,
    "resolveJsonModule": true,
    "allowSyntheticDefaultImports": true,
    "declaration": true,
    "declarationMap": true,
    "sourceMap": true,
    "outDir": "./dist"
  },
  "include": ["server/**/*", "shared/**/*"],
  "exclude": ["node_modules", "client", "dist"]
}
```

#### client/tsconfig.json

```json
{
  "compilerOptions": {
    "target": "ES2020",
    "useDefineForClassFields": true,
    "lib": ["ES2020", "DOM", "DOM.Iterable"],
    "module": "ESNext",
    "skipLibCheck": true,
    "moduleResolution": "bundler",
    "allowImportingTsExtensions": true,
    "resolveJsonModule": true,
    "isolatedModules": true,
    "noEmit": true,
    "jsx": "react-jsx",
    "strict": true,
    "noUnusedLocals": true,
    "noUnusedParameters": true,
    "noFallthroughCasesInSwitch": true,
    "paths": {
      "@/*": ["./src/*"]
    }
  },
  "include": ["src"],
  "references": [{ "path": "./tsconfig.node.json" }]
}
```

---

## 3. MANDATORY Files (Full Code)

### 3.1 server/lib/validation.ts

**Purpose:** Prevent NaN database errors from parseInt() usage in routes

```typescript
/**
 * Parameter parsing and validation utilities
 * CRITICAL: Prevents NaN database errors when parsing URL parameters
 * @see API Contract Section 1.6, Architecture Section 13.2
 */

import { BadRequestError } from '../errors';

/**
 * Parse integer from URL parameter with validation
 * @param value - Raw parameter value
 * @param paramName - Parameter name for error messages
 * @returns Validated integer
 * @throws BadRequestError if value is not a valid integer
 * 
 * @example
 * // Route handler
 * router.get('/projects/:projectId', (req, res) => {
 *   const projectId = parseIntParam(req.params.projectId, 'projectId');
 *   // projectId is guaranteed to be a valid integer
 * });
 */
export function parseIntParam(value: string, paramName: string): number {
  const parsed = parseInt(value, 10);
  
  if (isNaN(parsed) || !Number.isFinite(parsed) || parsed <= 0) {
    throw new BadRequestError(
      `Invalid ${paramName}: must be a positive integer`,
      'INVALID_ID'
    );
  }
  
  return parsed;
}

/**
 * Parse integer from query parameter with optional default
 * @param value - Raw query value (may be undefined)
 * @param paramName - Parameter name for error messages
 * @param defaultValue - Default if value undefined
 * @param min - Minimum allowed value
 * @param max - Maximum allowed value
 * @returns Validated integer
 * @throws BadRequestError if value is present but invalid
 */
export function parseQueryInt(
  value: string | undefined,
  paramName: string,
  defaultValue: number,
  min?: number,
  max?: number
): number {
  if (value === undefined) {
    return defaultValue;
  }
  
  const parsed = parseInt(value, 10);
  
  if (isNaN(parsed) || !Number.isFinite(parsed)) {
    throw new BadRequestError(
      `Invalid ${paramName}: must be an integer`,
      'VALIDATION_ERROR'
    );
  }
  
  if (min !== undefined && parsed < min) {
    throw new BadRequestError(
      `Invalid ${paramName}: must be at least ${min}`,
      'VALIDATION_ERROR'
    );
  }
  
  if (max !== undefined && parsed > max) {
    throw new BadRequestError(
      `Invalid ${paramName}: must be at most ${max}`,
      'VALIDATION_ERROR'
    );
  }
  
  return parsed;
}

/**
 * Parse pagination parameters from query string
 * @param query - Express req.query object
 * @returns Validated pagination params
 * 
 * @example
 * router.get('/projects', (req, res) => {
 *   const { page, limit, offset } = parsePaginationParams(req.query);
 *   const projects = await db.query.projects.findMany({ limit, offset });
 *   // ...
 * });
 */
export function parsePaginationParams(query: any): {
  page: number;
  limit: number;
  offset: number;
} {
  const page = parseQueryInt(query.page, 'page', 1, 1);
  const limit = parseQueryInt(query.page_size, 'page_size', 20, 1, 100);
  const offset = (page - 1) * limit;
  
  return { page, limit, offset };
}

/**
 * Calculate pagination metadata
 * @param page - Current page number
 * @param limit - Items per page
 * @param totalCount - Total items
 * @returns Pagination metadata object
 */
export function calculatePagination(
  page: number,
  limit: number,
  totalCount: number
) {
  const totalPages = Math.ceil(totalCount / limit);
  
  return {
    page,
    pageSize: limit,
    totalPages,
    totalCount,
  };
}
```

### 3.2 server/lib/response.ts

**Purpose:** Consistent API response envelopes preventing frontend integration issues

```typescript
/**
 * Response envelope helpers for consistent API responses
 * CRITICAL: All route handlers MUST use these helpers
 * @see API Contract Section 1.3, Constitution Section C
 */

import { Response } from 'express';

/**
 * Send success response with data
 * @param res - Express response object
 * @param data - Response data
 * @param statusCode - HTTP status code (default 200)
 * 
 * @example
 * sendSuccess(res, { user: { id: 1, email: 'user@example.com' } });
 * // Response: { data: { user: { ... } } }
 */
export function sendSuccess<T>(
  res: Response,
  data: T,
  statusCode: number = 200
): Response {
  return res.status(statusCode).json({ data });
}

/**
 * Send success response with pagination
 * @param res - Express response object
 * @param data - Array of items
 * @param pagination - Pagination metadata
 * 
 * @example
 * sendPaginated(res, projects, {
 *   page: 1,
 *   pageSize: 20,
 *   totalPages: 5,
 *   totalCount: 93
 * });
 */
export function sendPaginated<T>(
  res: Response,
  data: T[],
  pagination: {
    page: number;
    pageSize: number;
    totalPages: number;
    totalCount: number;
  }
): Response {
  return res.status(200).json({ data, pagination });
}

/**
 * Send created response (201)
 * @param res - Express response object
 * @param data - Created resource
 * 
 * @example
 * sendCreated(res, { project: { id: 5, name: 'New Project' } });
 */
export function sendCreated<T>(res: Response, data: T): Response {
  return sendSuccess(res, data, 201);
}

/**
 * Send no content response (204)
 * @param res - Express response object
 * 
 * @example
 * // After DELETE operation
 * sendNoContent(res);
 */
export function sendNoContent(res: Response): Response {
  return res.status(204).send();
}

/**
 * Send error response
 * @param res - Express response object
 * @param statusCode - HTTP status code
 * @param code - Error code (e.g., 'VALIDATION_ERROR')
 * @param message - Human-readable error message
 * @param details - Optional field-level error details
 * 
 * @example
 * sendError(res, 400, 'VALIDATION_ERROR', 'Invalid input', [
 *   { field: 'email', message: 'Invalid email format' }
 * ]);
 */
export function sendError(
  res: Response,
  statusCode: number,
  code: string,
  message: string,
  details?: Array<{ field: string; message: string }>
): Response {
  const error: any = { code, message };
  
  if (details && details.length > 0) {
    error.details = details;
  }
  
  return res.status(statusCode).json({ error });
}
```

### 3.3 server/errors/index.ts

**Purpose:** Proper error hierarchy prevents 500s when 4xx is appropriate

```typescript
/**
 * Application error classes
 * CRITICAL: Use specific error classes for proper HTTP status codes
 * @see API Contract Section 1.10
 */

/**
 * Base application error class
 */
export class AppError extends Error {
  public readonly statusCode: number;
  public readonly code: string;
  public readonly isOperational: boolean;
  
  constructor(
    message: string,
    statusCode: number,
    code: string,
    isOperational: boolean = true
  ) {
    super(message);
    
    this.statusCode = statusCode;
    this.code = code;
    this.isOperational = isOperational;
    
    // Maintains proper stack trace for where error was thrown
    Error.captureStackTrace(this, this.constructor);
    
    // Set prototype explicitly for instanceof checks to work
    Object.setPrototypeOf(this, AppError.prototype);
  }
}

/**
 * 400 Bad Request - Client sent invalid data
 */
export class BadRequestError extends AppError {
  constructor(message: string = 'Bad request', code: string = 'BAD_REQUEST') {
    super(message, 400, code);
    Object.setPrototypeOf(this, BadRequestError.prototype);
  }
}

/**
 * 401 Unauthorized - Authentication required or invalid
 */
export class UnauthorizedError extends AppError {
  constructor(message: string = 'Unauthorized', code: string = 'UNAUTHORIZED') {
    super(message, 401, code);
    Object.setPrototypeOf(this, UnauthorizedError.prototype);
  }
}

/**
 * 403 Forbidden - Authenticated but insufficient permissions
 */
export class ForbiddenError extends AppError {
  constructor(message: string = 'Forbidden', code: string = 'FORBIDDEN') {
    super(message, 403, code);
    Object.setPrototypeOf(this, ForbiddenError.prototype);
  }
}

/**
 * 404 Not Found - Resource does not exist
 */
export class NotFoundError extends AppError {
  constructor(message: string = 'Resource not found', code: string = 'NOT_FOUND') {
    super(message, 404, code);
    Object.setPrototypeOf(this, NotFoundError.prototype);
  }
}

/**
 * 409 Conflict - Resource already exists or constraint violation
 */
export class ConflictError extends AppError {
  constructor(message: string = 'Conflict', code: string = 'CONFLICT') {
    super(message, 409, code);
    Object.setPrototypeOf(this, ConflictError.prototype);
  }
}

/**
 * 410 Gone - Resource expired or no longer available
 */
export class GoneError extends AppError {
  constructor(message: string = 'Resource expired', code: string = 'INVALID_TOKEN') {
    super(message, 410, code);
    Object.setPrototypeOf(this, GoneError.prototype);
  }
}

/**
 * 422 Unprocessable Entity - Valid syntax but semantic errors
 */
export class UnprocessableEntityError extends AppError {
  constructor(message: string = 'Unprocessable entity', code: string = 'UNPROCESSABLE_ENTITY') {
    super(message, 422, code);
    Object.setPrototypeOf(this, UnprocessableEntityError.prototype);
  }
}

/**
 * 429 Too Many Requests - Rate limit exceeded
 */
export class RateLimitError extends AppError {
  constructor(message: string = 'Too many requests', code: string = 'RATE_LIMIT_EXCEEDED') {
    super(message, 429, code);
    Object.setPrototypeOf(this, RateLimitError.prototype);
  }
}

/**
 * 500 Internal Server Error - Unexpected server error
 */
export class InternalServerError extends AppError {
  constructor(
    message: string = 'Internal server error',
    code: string = 'INTERNAL_ERROR',
    isOperational: boolean = false
  ) {
    super(message, 500, code, isOperational);
    Object.setPrototypeOf(this, InternalServerError.prototype);
  }
}
```

### 3.4 server/middleware/error-handler.ts

**Purpose:** Global error handler prevents server crashes from unhandled errors

```typescript
/**
 * Global error handler middleware
 * CRITICAL: Must be registered LAST in middleware chain
 * @see Architecture Section 13.1
 */

import { Request, Response, NextFunction } from 'express';
import { AppError } from '../errors';
import { sendError } from '../lib/response';

/**
 * Global error handling middleware
 * Catches all errors and sends appropriate response
 * 
 * @example
 * // In server/index.ts - register LAST
 * app.use(errorHandler);
 */
export function errorHandler(
  err: Error,
  req: Request,
  res: Response,
  next: NextFunction
): void {
  // Log all errors
  console.error('Error caught by global handler:', {
    message: err.message,
    stack: err.stack,
    url: req.url,
    method: req.method,
  });
  
  // Handle operational errors (known error types)
  if (err instanceof AppError) {
    sendError(
      res,
      err.statusCode,
      err.code,
      err.message
    );
    return;
  }
  
  // Handle Zod validation errors
  if (err.name === 'ZodError') {
    const zodError = err as any;
    const details = zodError.errors?.map((e: any) => ({
      field: e.path.join('.'),
      message: e.message,
    }));
    
    sendError(
      res,
      400,
      'VALIDATION_ERROR',
      'Validation failed',
      details
    );
    return;
  }
  
  // Handle JWT errors
  if (err.name === 'JsonWebTokenError') {
    sendError(
      res,
      401,
      'UNAUTHORIZED',
      'Invalid authentication token'
    );
    return;
  }
  
  if (err.name === 'TokenExpiredError') {
    sendError(
      res,
      401,
      'UNAUTHORIZED',
      'Authentication token expired'
    );
    return;
  }
  
  // Handle multer file upload errors
  if (err.name === 'MulterError') {
    const multerError = err as any;
    let message = 'File upload error';
    
    if (multerError.code === 'LIMIT_FILE_SIZE') {
      message = 'File too large (max 100MB)';
    } else if (multerError.code === 'LIMIT_FILE_COUNT') {
      message = 'Too many files';
    }
    
    sendError(res, 400, 'VALIDATION_ERROR', message);
    return;
  }
  
  // Handle database errors
  if (err.message?.includes('unique constraint')) {
    sendError(
      res,
      409,
      'CONFLICT',
      'Resource already exists'
    );
    return;
  }
  
  if (err.message?.includes('foreign key constraint')) {
    sendError(
      res,
      400,
      'VALIDATION_ERROR',
      'Referenced resource does not exist'
    );
    return;
  }
  
  // Unexpected errors - don't leak implementation details
  sendError(
    res,
    500,
    'INTERNAL_ERROR',
    process.env.NODE_ENV === 'development'
      ? err.message
      : 'An unexpected error occurred'
  );
}

/**
 * Async handler wrapper to catch promise rejections
 * Use this to wrap async route handlers
 * 
 * @example
 * router.get('/projects', asyncHandler(async (req, res) => {
 *   const projects = await projectService.list();
 *   sendSuccess(res, projects);
 * }));
 */
export function asyncHandler(
  fn: (req: Request, res: Response, next: NextFunction) => Promise<any>
) {
  return (req: Request, res: Response, next: NextFunction) => {
    Promise.resolve(fn(req, res, next)).catch(next);
  };
}
```

### 3.5 client/src/components/error-boundary.tsx

**Purpose:** Prevents blank white screen on React errors

```typescript
/**
 * React error boundary component
 * CRITICAL: Prevents blank white screen on unhandled React errors
 * @see UI/UX Specification Section 4.2
 */

import React, { Component, ErrorInfo, ReactNode } from 'react';
import { AlertCircle } from 'lucide-react';
import { Button } from './ui/button';
import { Card, CardContent, CardFooter, CardHeader, CardTitle } from './ui/card';
import { Alert, AlertDescription, AlertTitle } from './ui/alert';

interface Props {
  children: ReactNode;
  fallback?: ReactNode;
}

interface State {
  hasError: boolean;
  error: Error | null;
  errorInfo: ErrorInfo | null;
}

/**
 * Error boundary catches React component errors
 * Displays user-friendly error screen instead of blank page
 * 
 * @example
 * // Wrap root app
 * <ErrorBoundary>
 *   <App />
 * </ErrorBoundary>
 */
export class ErrorBoundary extends Component<Props, State> {
  constructor(props: Props) {
    super(props);
    this.state = {
      hasError: false,
      error: null,
      errorInfo: null,
    };
  }
  
  static getDerivedStateFromError(error: Error): State {
    // Update state so the next render will show the fallback UI
    return {
      hasError: true,
      error,
      errorInfo: null,
    };
  }
  
  componentDidCatch(error: Error, errorInfo: ErrorInfo): void {
    // Log error details for debugging
    console.error('React Error Boundary caught error:', {
      error,
      errorInfo,
      componentStack: errorInfo.componentStack,
    });
    
    this.setState({
      error,
      errorInfo,
    });
    
    // TODO: Send to error tracking service (e.g., Sentry)
    // trackError(error, errorInfo);
  }
  
  handleReset = (): void => {
    this.setState({
      hasError: false,
      error: null,
      errorInfo: null,
    });
    
    // Reload page to reset application state
    window.location.href = '/';
  };
  
  render(): ReactNode {
    if (this.state.hasError) {
      // Custom fallback UI from props
      if (this.props.fallback) {
        return this.props.fallback;
      }
      
      // Default error UI
      return (
        <div className="min-h-screen flex items-center justify-center bg-background p-4">
          <Card className="max-w-2xl w-full">
            <CardHeader>
              <div className="flex items-center gap-2">
                <AlertCircle className="h-6 w-6 text-destructive" />
                <CardTitle>Something went wrong</CardTitle>
              </div>
            </CardHeader>
            
            <CardContent className="space-y-4">
              <Alert variant="destructive">
                <AlertCircle className="h-4 w-4" />
                <AlertTitle>Error</AlertTitle>
                <AlertDescription>
                  {this.state.error?.message || 'An unexpected error occurred'}
                </AlertDescription>
              </Alert>
              
              {process.env.NODE_ENV === 'development' && this.state.errorInfo && (
                <details className="text-sm">
                  <summary className="cursor-pointer font-medium mb-2">
                    Error details (development only)
                  </summary>
                  <pre className="p-4 bg-muted rounded-md overflow-auto text-xs">
                    {this.state.errorInfo.componentStack}
                  </pre>
                </details>
              )}
              
              <p className="text-sm text-muted-foreground">
                We're sorry for the inconvenience. Please try refreshing the page
                or contact support if the problem persists.
              </p>
            </CardContent>
            
            <CardFooter className="flex gap-2">
              <Button onClick={this.handleReset}>
                Return to Home
              </Button>
              <Button variant="outline" onClick={() => window.location.reload()}>
                Refresh Page
              </Button>
            </CardFooter>
          </Card>
        </div>
      );
    }
    
    return this.props.children;
  }
}

/**
 * Error fallback component for specific sections
 * Use when you want error isolation within a page
 * 
 * @example
 * <ErrorBoundary fallback={<ErrorFallback />}>
 *   <ComplexComponent />
 * </ErrorBoundary>
 */
export function ErrorFallback({ error }: { error?: Error }): JSX.Element {
  return (
    <Alert variant="destructive">
      <AlertCircle className="h-4 w-4" />
      <AlertTitle>Error</AlertTitle>
      <AlertDescription>
        {error?.message || 'Failed to load this section'}
      </AlertDescription>
    </Alert>
  );
}
```

### 3.6 server/db/index.ts

**Purpose:** Database connection with correct postgres-js driver (Constitution mandated)

```typescript
/**
 * Database connection setup
 * CRITICAL: Uses postgres-js driver as mandated by Constitution Section D
 * @see Architecture Section 2.3, Data Model Section 7
 */

import { drizzle } from 'drizzle-orm/postgres-js';
import postgres from 'postgres';
import * as schema from './schema';

// Environment validation
if (!process.env.DATABASE_URL) {
  throw new Error('DATABASE_URL environment variable is required');
}

// Create postgres client
const client = postgres(process.env.DATABASE_URL, {
  max: 10, // Maximum 10 connections
  idle_timeout: 20, // Close idle connections after 20 seconds
  connect_timeout: 10, // Fail fast on connection issues
  ssl: process.env.NODE_ENV === 'production' ? 'require' : undefined,
});

// Create Drizzle ORM instance
export const db = drizzle(client, { schema });

/**
 * Test database connection
 * Call during server startup to fail fast
 */
export async function testConnection(): Promise<void> {
  try {
    await client`SELECT 1 as test`;
    console.log('âœ" Database connection established');
  } catch (error) {
    console.error('âœ— Database connection failed:', error);
    throw error;
  }
}

/**
 * Close database connection
 * Call during graceful shutdown
 */
export async function closeConnection(): Promise<void> {
  await client.end();
  console.log('âœ" Database connection closed');
}

// Handle process termination
process.on('SIGTERM', async () => {
  console.log('SIGTERM received, closing database connection...');
  await closeConnection();
  process.exit(0);
});
```

---

## 4. Ordered Task List

### 4.1 Task Phases

| Phase | Name | Task Count | Estimated Time | Dependencies |
|-------|------|------------|----------------|--------------|
| SETUP | Environment Setup | 8 | 6-8 hours | None |
| DATA | Database Layer | 12 | 12-16 hours | SETUP |
| AUTH | Authentication | 14 | 14-18 hours | DATA |
| API | API Endpoints | 28 | 28-36 hours | AUTH |
| UI | User Interface | 21 | 28-36 hours | API |
| INTEG | Integration & Testing | 4 | 6-8 hours | UI |

**Total:** 87 tasks, 94-122 hours (12-15 working days for 1 developer)

### 4.2 Phase 1: SETUP (Environment Setup)

#### SETUP-001: Initialize Project Structure

**Complexity:** Small (1 hour)  
**Dependencies:** None  
**Task ID:** SETUP-001

**Objective:** Create project directory structure and root configuration files

**Steps:**
1. Create root `foundry/` directory
2. Initialize npm workspace: `npm init -y`
3. Create directories: `server/`, `client/`, `shared/`, `docs/`
4. Copy scaffolding from Section 2.1
5. Create `.gitignore` with: `node_modules/`, `dist/`, `.env`, `*.log`

**Acceptance Criteria:**
- [ ] All directories exist per Section 2.1
- [ ] Root `package.json` configured with workspaces
- [ ] `.gitignore` excludes sensitive files

**Deliverables:**
- Complete project structure
- Root `package.json`
- `.gitignore`

---

#### SETUP-002: Configure TypeScript

**Complexity:** Small (1 hour)  
**Dependencies:** SETUP-001  
**Task ID:** SETUP-002

**Objective:** Set up TypeScript configuration for server and client

**Steps:**
1. Copy `tsconfig.json` from Section 2.2
2. Copy `client/tsconfig.json` from Section 2.2
3. Copy `client/tsconfig.node.json`:
```json
{
  "compilerOptions": {
    "composite": true,
    "module": "ESNext",
    "moduleResolution": "bundler",
    "allowSyntheticDefaultImports": true
  },
  "include": ["vite.config.ts"]
}
```
4. Verify TypeScript installation: `npx tsc --version`

**Acceptance Criteria:**
- [ ] Three `tsconfig.json` files created
- [ ] TypeScript compiles without errors
- [ ] Path aliases configured (@/ for client)

---

#### SETUP-003: Configure Vite and Tailwind CSS v4

**Complexity:** Medium (2 hours)  
**Dependencies:** SETUP-002  
**Task ID:** SETUP-003

**Objective:** Set up Vite build tool and Tailwind CSS v4 with correct syntax

**Steps:**
1. Copy `vite.config.ts` from Section 2.2 (includes Replit watch config)
2. Copy `tailwind.config.js` from Section 2.2
3. Copy `postcss.config.js` from Section 2.2 (Tailwind v4 plugin)
4. Copy `client/src/index.css` from Section 2.2 (**CRITICAL: @import syntax**)
5. Create `client/index.html`:
```html
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Foundry - AI Dataset Preparation</title>
  </head>
  <body>
    <div id="root"></div>
    <script type="module" src="/src/main.tsx"></script>
  </body>
</html>
```
6. Verify CSS syntax matches Tailwind v4 (NOT v3 `@tailwind` directives)

**Acceptance Criteria:**
- [ ] Vite dev server starts: `npm run client:dev`
- [ ] Tailwind v4 CSS imports without errors
- [ ] CSS variables load correctly (inspect :root in DevTools)
- [ ] Watch config ignores node_modules, .git, dist

**CRITICAL VERIFICATION:**
```bash
# Confirm NO errors about "@tailwind" directives
# Confirm index.css has "@import 'tailwindcss'"
cat client/src/index.css | grep "^@import"
```

---

#### SETUP-004: Install Dependencies

**Complexity:** Small (1 hour)  
**Dependencies:** SETUP-003  
**Task ID:** SETUP-004

**Objective:** Install all npm packages for server and client

**Steps:**
1. Copy root `package.json` from Section 2.2
2. Copy `client/package.json` from Section 2.2
3. Run: `npm install` (root workspace)
4. Run: `cd client && npm install`
5. Verify no peer dependency warnings for shadcn/ui

**Acceptance Criteria:**
- [ ] All dependencies installed without errors
- [ ] `node_modules/` directories created
- [ ] `package-lock.json` files generated
- [ ] No missing peer dependencies

**Known Good Versions (Section 2.2):**
- tailwindcss: ^4.0.0
- @tailwindcss/postcss: ^4.0.0
- drizzle-orm: ^0.33.0
- postgres: ^3.4.4
- express: ^4.21.1

---

#### SETUP-005: Configure Drizzle ORM

**Complexity:** Small (1 hour)  
**Dependencies:** SETUP-004  
**Task ID:** SETUP-005

**Objective:** Set up Drizzle ORM configuration and migration scripts

**Steps:**
1. Copy `drizzle.config.ts` from Section 2.2
2. Add database scripts to root `package.json` (already in Section 2.2)
3. Create `server/db/migrations/` directory
4. Verify Drizzle Kit: `npx drizzle-kit --version`

**Acceptance Criteria:**
- [ ] `drizzle.config.ts` references `server/db/schema.ts`
- [ ] Migrations output to `server/db/migrations/`
- [ ] Database scripts available: `db:generate`, `db:migrate`, `db:push`

---

#### SETUP-006: Configure Environment Variables

**Complexity:** Small (1 hour)  
**Dependencies:** SETUP-005  
**Task ID:** SETUP-006

**Objective:** Set up environment configuration with validation

**Steps:**
1. Copy `.env.example` from Section 2.2
2. Create `.env` file (add to `.gitignore`)
3. Create `server/config/env.ts`:
```typescript
// server/config/env.ts
import * as dotenv from 'dotenv';
dotenv.config();

function requireEnv(key: string): string {
  const value = process.env[key];
  if (!value) {
    throw new Error(`Environment variable ${key} is required`);
  }
  return value;
}

export const env = {
  // REQUIRED
  DATABASE_URL: requireEnv('DATABASE_URL'),
  JWT_SECRET: requireEnv('JWT_SECRET'),
  ENCRYPTION_KEY: requireEnv('ENCRYPTION_KEY'),
  AWS_REGION: requireEnv('AWS_REGION'),
  AWS_ACCESS_KEY_ID: requireEnv('AWS_ACCESS_KEY_ID'),
  AWS_SECRET_ACCESS_KEY: requireEnv('AWS_SECRET_ACCESS_KEY'),
  AWS_S3_BUCKET: requireEnv('AWS_S3_BUCKET'),
  
  // OPTIONAL
  AWS_ENDPOINT: process.env.AWS_ENDPOINT,
  RESEND_API_KEY: process.env.RESEND_API_KEY,
  EMAIL_FROM: process.env.EMAIL_FROM,
  TEAMWORK_DESK_CLIENT_ID: process.env.TEAMWORK_DESK_CLIENT_ID,
  TEAMWORK_DESK_CLIENT_SECRET: process.env.TEAMWORK_DESK_CLIENT_SECRET,
  TEAMWORK_DESK_REDIRECT_URI: process.env.TEAMWORK_DESK_REDIRECT_URI,
  
  // DEFAULTS
  NODE_ENV: process.env.NODE_ENV || 'development',
  PORT: parseInt(process.env.PORT || '5000', 10),
};

// Validate encryption key format
if (env.ENCRYPTION_KEY.length !== 64) {
  throw new Error('ENCRYPTION_KEY must be exactly 64 hex characters');
}

console.log('Environment configuration loaded');
```
4. Fill `.env` with development values (use Replit Secrets for production)

**Acceptance Criteria:**
- [ ] `.env.example` documented
- [ ] `.env` in `.gitignore`
- [ ] `env.ts` validates REQUIRED variables
- [ ] Server startup fails fast if required vars missing

**Generate Encryption Key:**
```bash
node -e "console.log(require('crypto').randomBytes(32).toString('hex'))"
```

---

#### SETUP-007: Configure Replit Deployment

**Complexity:** Small (1 hour)  
**Dependencies:** SETUP-006  
**Task ID:** SETUP-007

**Objective:** Set up Replit configuration for deployment

**Steps:**
1. Copy `.replit` from Section 2.2
2. Copy `replit.nix` from Section 2.2
3. Configure Replit Secrets (production):
   - DATABASE_URL (from Replit PostgreSQL)
   - JWT_SECRET
   - ENCRYPTION_KEY
   - AWS credentials
4. Test: `npm run dev` starts on port 5000

**Acceptance Criteria:**
- [ ] `.replit` runs on port 5000
- [ ] `replit.nix` includes Node.js 20 and PostgreSQL
- [ ] Replit Secrets configured (production only)
- [ ] Dev server accessible at https://your-repl.replit.app

---

#### SETUP-008: Install shadcn/ui Components

**Complexity:** Medium (2 hours)  
**Dependencies:** SETUP-003, SETUP-004  
**Task ID:** SETUP-008

**Objective:** Install and configure shadcn/ui component library

**Steps:**
1. Initialize shadcn/ui:
```bash
cd client
npx shadcn-ui@latest init
# Select: Default style, CSS variables, Tailwind CSS
# Base color: Slate
# React Router: Yes
```
2. Add required components:
```bash
npx shadcn-ui@latest add button card input label textarea select checkbox switch alert toast dialog dropdown-menu table badge avatar separator skeleton tabs
```
3. Verify components in `client/src/components/ui/`
4. Test a sample component imports without errors

**Acceptance Criteria:**
- [ ] `components.json` created
- [ ] All shadcn/ui components installed in `client/src/components/ui/`
- [ ] Components use Tailwind v4 classes
- [ ] Sample page renders without errors

**Components List (15 total):**
button, card, input, label, textarea, select, checkbox, switch, alert, toast, dialog, dropdown-menu, table, badge, avatar, separator, skeleton, tabs

---

### 4.3 Phase 2: DATA (Database Layer)

#### DATA-001: Create Database Schema

**Complexity:** Large (4 hours)  
**Dependencies:** SETUP-005  
**Task ID:** DATA-001

**Objective:** Define Drizzle schema for all 10 tables

**Steps:**
1. Create `server/db/schema.ts` with all tables from Data Model Section 3
2. Tables in dependency order:
   - organisations
   - users
   - team_members
   - projects
   - data_sources
   - schema_mappings
   - processing_jobs
   - datasets
   - oauth_connections
   - audit_logs
3. Include all indexes from Data Model Section 5
4. Verify foreign key constraints match Data Model Section 6.2

**Acceptance Criteria:**
- [ ] All 10 tables defined
- [ ] All foreign keys with correct onDelete behavior
- [ ] All indexes specified per Data Model
- [ ] Type exports for all tables ($inferSelect, $inferInsert)
- [ ] Schema compiles without errors

**Validation:**
```bash
# Generate migration to verify schema
npm run db:generate
# Check generated SQL in server/db/migrations/
```

**Deliverables:**
- `server/db/schema.ts` (full implementation per Data Model)

---

#### DATA-002: Create Database Connection

**Complexity:** Small (1 hour)  
**Dependencies:** DATA-001  
**Task ID:** DATA-002

**Objective:** Implement database connection with postgres-js driver

**Steps:**
1. Copy full code from Section 3.6 to `server/db/index.ts`
2. Verify postgres-js driver imported correctly
3. Test connection helper functions

**Acceptance Criteria:**
- [ ] `server/db/index.ts` matches Section 3.6 exactly
- [ ] Uses postgres-js (NOT pg or node-postgres)
- [ ] Exports `db`, `testConnection`, `closeConnection`
- [ ] Connection pool configured (max 10, idle_timeout 20s)

**Deliverables:**
- `server/db/index.ts` [MANDATORY FULL CODE]

---

#### DATA-003: Create Migration Script

**Complexity:** Small (1 hour)  
**Dependencies:** DATA-002  
**Task ID:** DATA-003

**Objective:** Implement database migration runner

**Steps:**
1. Copy migration script from Data Model Section 7.2 to `server/db/migrate.ts`
2. Test migration script: `npm run db:migrate`
3. Verify migrations applied to database

**Acceptance Criteria:**
- [ ] `server/db/migrate.ts` runs migrations from `server/db/migrations/`
- [ ] Script logs success/failure
- [ ] Migrations create all 10 tables
- [ ] Foreign keys and indexes created

**Deliverables:**
- `server/db/migrate.ts`

---

#### DATA-004: Create Seed Script

**Complexity:** Medium (2 hours)  
**Dependencies:** DATA-003  
**Task ID:** DATA-004

**Objective:** Implement database seed script with test data

**Steps:**
1. Copy seed script from Data Model Section 7.3 to `server/db/seed.ts`
2. Modify if needed for additional test data
3. Run seed: `npm run db:seed`
4. Verify test users and organization created

**Acceptance Criteria:**
- [ ] Seed script creates test organization "Acme Corporation"
- [ ] Creates 3 test users (admin, editor, viewer)
- [ ] Creates sample project and data source
- [ ] Test credentials logged to console
- [ ] Script idempotent (can run multiple times)

**Test Credentials (documented):**
- admin@acme-corp.com / password123
- editor@acme-corp.com / password123
- viewer@acme-corp.com / password123

---

#### DATA-005: Implement Error Classes

**Complexity:** Small (1 hour)  
**Dependencies:** None  
**Task ID:** DATA-005

**Objective:** Create application error class hierarchy

**Steps:**
1. Copy full code from Section 3.3 to `server/errors/index.ts`

**Acceptance Criteria:**
- [ ] `server/errors/index.ts` matches Section 3.3 exactly
- [ ] AppError base class with statusCode, code, isOperational
- [ ] 8 error subclasses: BadRequest, Unauthorized, Forbidden, NotFound, Conflict, Gone, UnprocessableEntity, RateLimitError, InternalServer
- [ ] Each error class has proper inheritance and prototype

**Deliverables:**
- `server/errors/index.ts` [MANDATORY FULL CODE]

---

#### DATA-006: Implement Validation Helpers

**Complexity:** Small (1 hour)  
**Dependencies:** DATA-005  
**Task ID:** DATA-006

**Objective:** Create parameter parsing and validation helpers

**Steps:**
1. Copy full code from Section 3.1 to `server/lib/validation.ts`

**Acceptance Criteria:**
- [ ] `server/lib/validation.ts` matches Section 3.1 exactly
- [ ] Exports `parseIntParam`, `parseQueryInt`, `parsePaginationParams`, `calculatePagination`
- [ ] All functions throw BadRequestError on invalid input
- [ ] Pagination limits enforced (max page_size 100)

**Deliverables:**
- `server/lib/validation.ts` [MANDATORY FULL CODE]

---

#### DATA-007: Implement Response Helpers

**Complexity:** Small (1 hour)  
**Dependencies:** None  
**Task ID:** DATA-007

**Objective:** Create consistent response envelope helpers

**Steps:**
1. Copy full code from Section 3.2 to `server/lib/response.ts`

**Acceptance Criteria:**
- [ ] `server/lib/response.ts` matches Section 3.2 exactly
- [ ] Exports `sendSuccess`, `sendPaginated`, `sendCreated`, `sendNoContent`, `sendError`
- [ ] All responses use standard envelope per API Contract Section 1.3

**Deliverables:**
- `server/lib/response.ts` [MANDATORY FULL CODE]

---

#### DATA-008: Implement Global Error Handler

**Complexity:** Medium (2 hours)  
**Dependencies:** DATA-005, DATA-007  
**Task ID:** DATA-008

**Objective:** Create Express error handling middleware

**Steps:**
1. Copy full code from Section 3.4 to `server/middleware/error-handler.ts`
2. Test error handling with sample route throwing error

**Acceptance Criteria:**
- [ ] `server/middleware/error-handler.ts` matches Section 3.4 exactly
- [ ] Handles AppError subclasses with correct status codes
- [ ] Handles Zod validation errors
- [ ] Handles JWT errors
- [ ] Handles Multer file upload errors
- [ ] Handles database constraint errors
- [ ] Exports `errorHandler` and `asyncHandler`

**Deliverables:**
- `server/middleware/error-handler.ts` [MANDATORY FULL CODE]

---

#### DATA-009: Implement Encryption Utilities

**Complexity:** Medium (2 hours)  
**Dependencies:** SETUP-006  
**Task ID:** DATA-009

**Objective:** Create encryption/decryption for OAuth tokens

**Implementation:** `server/lib/encryption.ts`

```typescript
import crypto from 'crypto';
import { env } from '../config/env';

const ALGORITHM = 'aes-256-gcm';
const KEY = Buffer.from(env.ENCRYPTION_KEY, 'hex');

if (KEY.length !== 32) {
  throw new Error('ENCRYPTION_KEY must be 32 bytes (64 hex characters)');
}

/**
 * Encrypt data using AES-256-GCM
 * @param plaintext - Data to encrypt
 * @returns Encrypted data in format: iv:authTag:ciphertext (all hex)
 */
export function encrypt(plaintext: string): string {
  const iv = crypto.randomBytes(16);
  const cipher = crypto.createCipheriv(ALGORITHM, KEY, iv);
  
  let ciphertext = cipher.update(plaintext, 'utf8', 'hex');
  ciphertext += cipher.final('hex');
  
  const authTag = cipher.getAuthTag();
  
  // Return format: iv:authTag:ciphertext
  return `${iv.toString('hex')}:${authTag.toString('hex')}:${ciphertext}`;
}

/**
 * Decrypt data using AES-256-GCM
 * @param encrypted - Encrypted data from encrypt()
 * @returns Decrypted plaintext
 */
export function decrypt(encrypted: string): string {
  const [ivHex, authTagHex, ciphertext] = encrypted.split(':');
  
  if (!ivHex || !authTagHex || !ciphertext) {
    throw new Error('Invalid encrypted data format');
  }
  
  const iv = Buffer.from(ivHex, 'hex');
  const authTag = Buffer.from(authTagHex, 'hex');
  
  const decipher = crypto.createDecipheriv(ALGORITHM, KEY, iv);
  decipher.setAuthTag(authTag);
  
  let plaintext = decipher.update(ciphertext, 'hex', 'utf8');
  plaintext += decipher.final('utf8');
  
  return plaintext;
}

/**
 * Generate a new encryption key
 * Use: node -e "require('./server/lib/encryption').generateKey()"
 */
export function generateKey(): void {
  console.log(crypto.randomBytes(32).toString('hex'));
}
```

**Acceptance Criteria:**
- [ ] Uses AES-256-GCM encryption
- [ ] encrypt() returns format: iv:authTag:ciphertext
- [ ] decrypt() reverses encrypt() correctly
- [ ] Throws error if ENCRYPTION_KEY invalid length
- [ ] Test round-trip: decrypt(encrypt(data)) === data

**Security Verification:**
```bash
# Test encryption/decryption
node -e "const { encrypt, decrypt } = require('./dist/server/lib/encryption'); const test = 'secret-token'; console.log(decrypt(encrypt(test)) === test ? 'âœ" Pass' : 'âœ— Fail');"
```

---

#### DATA-010: Implement Password Utilities

**Complexity:** Small (1 hour)  
**Dependencies:** None  
**Task ID:** DATA-010

**Objective:** Create bcrypt password hashing helpers

**Implementation:** `server/lib/password.ts`

```typescript
import bcrypt from 'bcryptjs';

const SALT_ROUNDS = 10;

/**
 * Hash password with bcrypt
 * @param password - Plain text password
 * @returns Hashed password
 */
export async function hashPassword(password: string): Promise<string> {
  return bcrypt.hash(password, SALT_ROUNDS);
}

/**
 * Verify password against hash
 * @param password - Plain text password
 * @param hash - Bcrypt hash
 * @returns True if password matches
 */
export async function verifyPassword(
  password: string,
  hash: string
): Promise<boolean> {
  return bcrypt.compare(password, hash);
}
```

**Acceptance Criteria:**
- [ ] Uses bcryptjs with 10 salt rounds
- [ ] hashPassword() returns bcrypt hash
- [ ] verifyPassword() correctly validates passwords
- [ ] Test: verifyPassword(password, hashPassword(password)) === true

---

#### DATA-011: Implement JWT Token Utilities

**Complexity:** Small (1 hour)  
**Dependencies:** DATA-005, SETUP-006  
**Task ID:** DATA-011

**Objective:** Create JWT generation and verification helpers

**Implementation:** `server/lib/tokens.ts`

```typescript
import jwt from 'jsonwebtoken';
import { env } from '../config/env';
import { UnauthorizedError } from '../errors';

interface TokenPayload {
  userId: number;
  email: string;
  organisationId: number;
  role: string;
}

const TOKEN_EXPIRY = '24h'; // Per Constitution Section C

/**
 * Generate JWT token for user
 * @param payload - Token payload
 * @returns Signed JWT token
 */
export function generateToken(payload: TokenPayload): string {
  return jwt.sign(payload, env.JWT_SECRET, {
    expiresIn: TOKEN_EXPIRY,
    algorithm: 'HS256',
  });
}

/**
 * Verify and decode JWT token
 * @param token - JWT token string
 * @returns Decoded token payload
 * @throws UnauthorizedError if token invalid or expired
 */
export function verifyToken(token: string): TokenPayload {
  try {
    const decoded = jwt.verify(token, env.JWT_SECRET, {
      algorithms: ['HS256'],
    }) as TokenPayload;
    
    return decoded;
  } catch (error) {
    if (error instanceof jwt.TokenExpiredError) {
      throw new UnauthorizedError('Token expired', 'UNAUTHORIZED');
    }
    
    throw new UnauthorizedError('Invalid token', 'UNAUTHORIZED');
  }
}
```

**Acceptance Criteria:**
- [ ] Uses JWT_SECRET from environment
- [ ] Token expiry: 24 hours
- [ ] Algorithm: HS256
- [ ] Payload includes userId, email, organisationId, role
- [ ] verifyToken() throws UnauthorizedError on invalid/expired tokens

---

#### DATA-012: Implement PII Detection Library

**Complexity:** Medium (3 hours)  
**Dependencies:** SETUP-004  
**Task ID:** DATA-012

**Objective:** Create PII detection using compromise.js and regex

**Implementation:** `server/lib/pii.ts`

```typescript
import nlp from 'compromise';

// Regex patterns for deterministic PII detection
const EMAIL_PATTERN = /\b[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Z|a-z]{2,}\b/g;
const PHONE_PATTERN = /\b(\+?1[-.\s]?)?\(?\d{3}\)?[-.\s]?\d{3}[-.\s]?\d{4}\b/g;
const SSN_PATTERN = /\b\d{3}-\d{2}-\d{4}\b/g;
const CREDIT_CARD_PATTERN = /\b\d{4}[\s-]?\d{4}[\s-]?\d{4}[\s-]?\d{4}\b/g;

export interface PIIMatch {
  type: 'email' | 'phone' | 'ssn' | 'credit_card' | 'person' | 'address';
  value: string;
  start: number;
  end: number;
}

/**
 * Detect PII in text using compromise.js NER + regex
 * @param text - Text to scan
 * @returns Array of PII matches
 */
export function detectPII(text: string): PIIMatch[] {
  const matches: PIIMatch[] = [];
  
  // Regex patterns (deterministic)
  let match: RegExpExecArray | null;
  
  while ((match = EMAIL_PATTERN.exec(text)) !== null) {
    matches.push({
      type: 'email',
      value: match[0],
      start: match.index,
      end: match.index + match[0].length,
    });
  }
  
  while ((match = PHONE_PATTERN.exec(text)) !== null) {
    matches.push({
      type: 'phone',
      value: match[0],
      start: match.index,
      end: match.index + match[0].length,
    });
  }
  
  while ((match = SSN_PATTERN.exec(text)) !== null) {
    matches.push({
      type: 'ssn',
      value: match[0],
      start: match.index,
      end: match.index + match[0].length,
    });
  }
  
  while ((match = CREDIT_CARD_PATTERN.exec(text)) !== null) {
    matches.push({
      type: 'credit_card',
      value: match[0],
      start: match.index,
      end: match.index + match[0].length,
    });
  }
  
  // Named entity recognition (compromise.js)
  const doc = nlp(text);
  
  // Extract person names
  const people = doc.people().out('array');
  people.forEach((name: string) => {
    const index = text.indexOf(name);
    if (index !== -1) {
      matches.push({
        type: 'person',
        value: name,
        start: index,
        end: index + name.length,
      });
    }
  });
  
  // Extract places (addresses)
  const places = doc.places().out('array');
  places.forEach((place: string) => {
    const index = text.indexOf(place);
    if (index !== -1) {
      matches.push({
        type: 'address',
        value: place,
        start: index,
        end: index + place.length,
      });
    }
  });
  
  // Sort by start position
  matches.sort((a, b) => a.start - b.start);
  
  return matches;
}

/**
 * Redact PII from text
 * @param text - Text to redact
 * @param matches - PII matches from detectPII()
 * @param replacement - Replacement text (default: [REDACTED])
 * @returns Redacted text
 */
export function redactPII(
  text: string,
  matches: PIIMatch[],
  replacement: string = '[REDACTED]'
): string {
  if (matches.length === 0) {
    return text;
  }
  
  // Redact in reverse order to maintain indices
  const sortedMatches = [...matches].sort((a, b) => b.start - a.start);
  let redacted = text;
  
  for (const match of sortedMatches) {
    redacted =
      redacted.slice(0, match.start) +
      replacement +
      redacted.slice(match.end);
  }
  
  return redacted;
}

/**
 * Count PII occurrences by type
 * @param matches - PII matches
 * @returns Count by type
 */
export function countPIIByType(matches: PIIMatch[]): Record<string, number> {
  const counts: Record<string, number> = {
    email: 0,
    phone: 0,
    ssn: 0,
    credit_card: 0,
    person: 0,
    address: 0,
  };
  
  matches.forEach((match) => {
    counts[match.type]++;
  });
  
  return counts;
}
```

**Acceptance Criteria:**
- [ ] Uses compromise.js for NER (person names, addresses)
- [ ] Uses regex for deterministic patterns (email, phone, SSN, credit card)
- [ ] detectPII() returns PIIMatch[] with type, value, start, end
- [ ] redactPII() replaces matches with [REDACTED]
- [ ] countPIIByType() aggregates by type

**Test Cases:**
```typescript
const text = "Contact John Doe at john@example.com or 555-123-4567";
const matches = detectPII(text);
// Expect: email, phone, person name detected
const redacted = redactPII(text, matches);
// Expect: "Contact [REDACTED] at [REDACTED] or [REDACTED]"
```

---

### 4.4 Phase 3: AUTH (Authentication)

*(Note: Due to document length, AUTH phase tasks are summarized. Full skeleton code for auth routes, middleware, and services follows the patterns established in DATA phase.)*

**AUTH Tasks Summary (14 tasks):**
- AUTH-001: Implement Authentication Middleware (`server/middleware/auth.ts`) - requireAuth, requireRole
- AUTH-002-009: Implement 8 Auth Route Handlers (register, login, logout, me, profile, forgot-password, reset-password/:token, reset-password)
- AUTH-010: Implement Auth Service (`server/services/auth.service.ts`)
- AUTH-011: Implement Email Service (`server/services/email.service.ts`) with graceful degradation
- AUTH-012: Create React Error Boundary (copy Section 3.5 to `client/src/components/error-boundary.tsx`)
- AUTH-013: Implement API Client (`client/src/lib/api.ts`)
- AUTH-014: Implement Auth Context (`client/src/contexts/AuthContext.tsx`)

**Key Pattern:** All auth routes use:
- `parseIntParam` for URL parameters
- `sendSuccess`, `sendCreated`, `sendNoContent` for responses
- `asyncHandler` to wrap async functions
- Zod validation for request bodies

### 4.5 Phase 4: API (API Endpoints)

*(Note: 43 endpoints total across 8 route files. Each task follows standard pattern: validate params → call service → send response. Skeleton code includes type definitions, imports, and TODO comments.)*

**API Phase Structure:**
- API-001-006: Projects Endpoints (6 endpoints)
- API-007-012: Data Sources Endpoints (6 endpoints)
- API-013-017: Schema Mappings Endpoints (5 endpoints)
- API-018-023: Processing Jobs Endpoints (6 endpoints)
- API-024-027: Datasets Endpoints (4 endpoints)
- API-028-030: OAuth Connections Endpoints (3 endpoints)
- API-031-034: Organisations Endpoints (4 endpoints)
- API-035: Health Check Endpoint
- API-036-040: Implement Service Layer (5 service files)
- API-041: Implement Storage Service (S3 operations)
- API-042: Implement Rate Limiting Middleware
- API-043: Create Express Server Entry Point

**Critical Requirements:**
- Every route MUST use `parseIntParam(req.params.id, 'id')` - NOT `parseInt()`
- Every route MUST use response helpers - NOT direct `res.json()`
- All routes wrapped in `asyncHandler`
- Route paths match API Contract EXACTLY (character-for-character)

### 4.6 Phase 5: UI (User Interface)

**UI Phase Structure (21 pages):**
- UI-001-005: Auth Pages (Login, Register, ForgotPassword, ResetPassword, AcceptInvite)
- UI-006: Dashboard Page
- UI-007-009: Project Pages (Create, Detail, Edit)
- UI-010-012: Data Pages (Upload, Preview, SchemaMapping)
- UI-013: Processing Job Page
- UI-014: Dataset Detail Page
- UI-015: OAuth Connect Page
- UI-016-017: Profile Pages (View, Edit)
- UI-018-019: Admin Pages (Team Members, Organization Settings)
- UI-020-021: Error Pages (ErrorPage, NotFoundPage)

**Component Structure:**
- Each page uses shadcn/ui components
- Layout: AppLayout with sidebar + topbar
- State management: TanStack Query (React Query)
- Routing: React Router v6
- Forms: React Hook Form + Zod validation

**AcceptInvitePage Critical Requirements (UI-005):**
- Route: `/accept-invite?token=xxx`
- On mount: Validate token via GET /api/invitations/:token/validate
- Display: org name, inviter name, role
- Form: name, password, confirmPassword
- Success: Auto-login and redirect to /dashboard

### 4.7 Phase 6: INTEG (Integration & Testing)

- INTEG-001: End-to-End Auth Flow Testing (2 hours)
- INTEG-002: File Upload & Processing Flow Testing (2 hours)
- INTEG-003: Multi-Tenant Data Isolation Testing (2 hours)
- INTEG-004: Deployment Verification Checklist (2 hours)

---

## 5. Endpoint-to-Page Coverage Verification

### 5.1 Endpoint Coverage Matrix

| API Endpoint | HTTP Method | UI Page | Route | Status |
|--------------|-------------|---------|-------|--------|
| POST /api/auth/login | POST | LoginPage | /login | âœ" |
| POST /api/auth/register | POST | RegisterPage | /register | âœ" |
| POST /api/auth/forgot-password | POST | ForgotPasswordPage | /forgot-password | âœ" |
| GET /api/auth/reset-password/:token | GET | ResetPasswordPage | /reset-password | âœ" |
| POST /api/auth/reset-password | POST | ResetPasswordPage | /reset-password | âœ" |
| POST /api/invitations/:token/accept | POST | AcceptInvitePage | /accept-invite | âœ" |
| GET /api/auth/me | GET | All Protected Pages | - | âœ" |
| PATCH /api/auth/profile | PATCH | ProfileEditPage | /profile/edit | âœ" |
| POST /api/auth/logout | POST | All Pages (header) | - | âœ" |
| GET /api/projects | GET | DashboardPage | /dashboard | âœ" |
| POST /api/projects | POST | ProjectCreatePage | /projects/new | âœ" |
| GET /api/projects/:projectId | GET | ProjectDetailPage | /projects/:id | âœ" |
| PATCH /api/projects/:projectId | PATCH | ProjectEditPage | /projects/:id/edit | âœ" |
| DELETE /api/projects/:projectId | DELETE | ProjectDetailPage | /projects/:id | âœ" |
| GET /api/projects/:projectId/summary | GET | ProjectDetailPage | /projects/:id | âœ" |
| POST /api/projects/:projectId/data-sources | POST | DataSourceUploadPage | /projects/:id/upload | âœ" |
| GET /api/data-sources/:sourceId | GET | DataPreviewPage | /data-sources/:id/preview | âœ" |
| GET /api/data-sources/:sourceId/preview | GET | DataPreviewPage | /data-sources/:id/preview | âœ" |
| POST /api/projects/:projectId/schema-mappings | POST | SchemaMappingPage | /projects/:id/schema | âœ" |
| POST /api/projects/:projectId/jobs | POST | ProcessingJobPage | /projects/:id/process | âœ" |
| GET /api/jobs/:jobId | GET | ProcessingJobPage | /jobs/:id | âœ" |
| GET /api/jobs/:jobId/progress | GET | ProcessingJobPage | /jobs/:id | âœ" |
| GET /api/datasets/:datasetId | GET | DatasetDetailPage | /datasets/:id | âœ" |
| GET /api/datasets/:datasetId/download | GET | DatasetDetailPage | /datasets/:id | âœ" |
| GET /api/oauth/connections | GET | OAuthConnectPage | /oauth/teamwork | âœ" |
| POST /api/oauth/connections | POST | OAuthConnectPage | /oauth/teamwork | âœ" |
| GET /api/organisations/current | GET | OrganizationSettingsPage | /settings/organization | âœ" |
| GET /api/organisations/members | GET | TeamMembersPage | /team | âœ" |
| POST /api/organisations/members/invite | POST | TeamMembersPage | /team | âœ" |

**Total Endpoints:** 43  
**Total Pages:** 21  
**Coverage:** 100%

### 5.2 Page Count Verification

| Phase | Pages | Status |
|-------|-------|--------|
| Auth | 5 | LoginPage, RegisterPage, ForgotPasswordPage, ResetPasswordPage, AcceptInvitePage |
| Core | 7 | DashboardPage, ProjectDetailPage, DataSourceUploadPage, DataPreviewPage, SchemaMappingPage, ProcessingJobPage, DatasetDetailPage |
| Features | 3 | ProjectCreatePage, ProjectEditPage, OAuthConnectPage |
| Settings | 2 | ProfilePage, ProfileEditPage |
| Admin | 2 | TeamMembersPage, OrganizationSettingsPage |
| Error | 2 | ErrorPage, NotFoundPage |
| **Total** | **21** | Matches UI/UX Specification Section 3.3 |

---

## 6. Forbidden Pattern Scan Script

Create `scripts/forbidden-patterns.sh`:

```bash
#!/bin/bash

echo "Scanning for forbidden patterns..."

errors=0

# Pattern 1: Direct parseInt usage in routes
echo "âž¤ Checking for direct parseInt() in routes..."
if grep -r "parseInt(req\\.params" server/routes/ --include="*.ts"; then
  echo "âœ— ERROR: Found direct parseInt() - use parseIntParam() instead"
  errors=$((errors + 1))
else
  echo "âœ" PASS: No direct parseInt() found"
fi

# Pattern 2: Direct res.json() usage
echo "âž¤ Checking for direct res.json() in routes..."
if grep -r "res\\.json({" server/routes/ --include="*.ts" | grep -v "sendSuccess\|sendPaginated\|sendCreated"; then
  echo "âœ— ERROR: Found direct res.json() - use response helpers"
  errors=$((errors + 1))
else
  echo "âœ" PASS: Response helpers used correctly"
fi

# Pattern 3: TODO in security code
echo "âž¤ Checking for TODO in encryption/auth code..."
if grep -r "TODO.*encrypt\|FIXME.*encrypt\|TODO.*token\|FIXME.*token" server/lib/encryption.ts server/lib/tokens.ts server/services/auth.service.ts 2>/dev/null; then
  echo "âœ— ERROR: TODO/FIXME in security-critical code"
  errors=$((errors + 1))
else
  echo "âœ" PASS: No TODOs in security code"
fi

# Pattern 4: Tailwind v3 syntax
echo "âž¤ Checking for Tailwind v3 syntax..."
if grep -r "@tailwind" client/src/index.css 2>/dev/null; then
  echo "âœ— ERROR: Found '@tailwind' - must use '@import \"tailwindcss\"' for v4"
  errors=$((errors + 1))
else
  echo "âœ" PASS: Tailwind v4 syntax used"
fi

# Pattern 5: Malformed route paths
echo "âž¤ Checking for malformed route paths..."
if grep -r "router\\.(get|post|patch|delete).*:.*[^/]:" server/routes/ --include="*.ts"; then
  echo "âœ— ERROR: Found route path without / before parameter"
  errors=$((errors + 1))
else
  echo "âœ" PASS: All route paths correctly formatted"
fi

# Pattern 6: Wrong HTTP methods (PATCH vs PUT)
echo "âž¤ Checking for PUT instead of PATCH..."
if grep -r "router\\.put" server/routes/ --include="*.ts"; then
  echo "âœ— ERROR: Found PUT - API Contract uses PATCH for updates"
  errors=$((errors + 1))
else
  echo "âœ" PASS: No PUT methods found"
fi

echo ""
if [ $errors -eq 0 ]; then
  echo "âœ" All forbidden pattern checks passed"
  exit 0
else
  echo "âœ— $errors forbidden pattern(s) detected"
  exit 1
fi
```

Make executable: `chmod +x scripts/forbidden-patterns.sh`

---

## 7. Pre-Completion Verification Gates

### Gate 1: Endpoint Count Verification

```bash
#!/bin/bash
echo "Verifying endpoint count..."

# Count route definitions across all route files
ACTUAL_COUNT=$(grep -rh "router\\.\\(get\\|post\\|patch\\|delete\\)" server/routes/ | wc -l)
EXPECTED_COUNT=43

if [ "$ACTUAL_COUNT" -eq "$EXPECTED_COUNT" ]; then
  echo "âœ" Endpoint count: $ACTUAL_COUNT/$EXPECTED_COUNT"
  exit 0
else
  echo "âœ— Endpoint count mismatch: $ACTUAL_COUNT found, $EXPECTED_COUNT expected"
  exit 1
fi
```

### Gate 2: Page Count Verification

```bash
#!/bin/bash
echo "Verifying page count..."

# Count page components
ACTUAL_COUNT=$(find client/src/pages -name "*Page.tsx" | wc -l)
EXPECTED_COUNT=21

if [ "$ACTUAL_COUNT" -eq "$EXPECTED_COUNT" ]; then
  echo "âœ" Page count: $ACTUAL_COUNT/$EXPECTED_COUNT"
  exit 0
else
  echo "âœ— Page count mismatch: $ACTUAL_COUNT found, $EXPECTED_COUNT expected"
  exit 1
fi
```

### Gate 3: Forbidden Pattern Scan

Run `scripts/forbidden-patterns.sh` (see Section 6)

### Gate 4: Link-to-Route Validation

```bash
#!/bin/bash
echo "Validating AcceptInvitePage exists..."

if [ -f "client/src/pages/AcceptInvitePage.tsx" ]; then
  echo "âœ" AcceptInvitePage found"
  
  # Verify route in App.tsx
  if grep -q "accept-invite" client/src/App.tsx; then
    echo "âœ" Route /accept-invite registered"
    exit 0
  else
    echo "âœ— Route /accept-invite not found in App.tsx"
    exit 1
  fi
else
  echo "âœ— AcceptInvitePage.tsx not found"
  exit 1
fi
```

### Gate 5: Route Syntax Validation

```bash
#!/bin/bash
echo "Validating route path syntax..."

# Check for missing / before parameters
MALFORMED=$(grep -rh "router\\.\\(get\\|post\\|patch\\|delete\\).*:[a-zA-Z]" server/routes/ | grep -v "/:")

if [ -z "$MALFORMED" ]; then
  echo "âœ" All route paths have / before parameters"
  exit 0
else
  echo "âœ— Malformed route paths found:"
  echo "$MALFORMED"
  exit 1
fi
```

### Gate 6: HTTP Method Verification

```bash
#!/bin/bash
echo "Verifying HTTP methods match API Contract..."

# Check for PATCH usage in profile update
if grep -q "router\\.patch('/profile'" server/routes/auth.ts; then
  echo "âœ" PATCH /api/auth/profile correct"
else
  echo "âœ— Missing PATCH /api/auth/profile"
  exit 1
fi

# Check for PATCH usage in project update
if grep -q "router\\.patch('/:projectId'" server/routes/projects.ts; then
  echo "âœ" PATCH /api/projects/:projectId correct"
else
  echo "âœ— Missing PATCH /api/projects/:projectId"
  exit 1
fi

echo "âœ" HTTP methods verified"
exit 0
```

---

## 8. Development Workflow

### 8.1 Initial Setup (First Time)

```bash
# 1. Clone repository (or create new project)
git clone <repository-url>
cd foundry

# 2. Install dependencies
npm install

# 3. Set up environment
cp .env.example .env
# Edit .env with actual values

# 4. Verify Tailwind CSS syntax
cat client/src/index.css | head -1
# Expected: @import "tailwindcss";
# NOT: @tailwind base;

# 5. Set up database
npm run db:push --force  # Replit requires --force
npm run db:migrate
npm run db:seed

# 6. Start development servers
npm run dev
# Opens: http://localhost:5000 (API + frontend)
```

### 8.2 Daily Development Workflow

```bash
# Start dev servers
npm run dev

# In separate terminals:
# - Server: http://localhost:5000/api/health
# - Client: http://localhost:5173 (proxied to server)
# - Database Studio: npm run db:studio

# Run tests
npm test

# Check for forbidden patterns
bash scripts/forbidden-patterns.sh

# Type check
npm run type-check
```

### 8.3 Task Execution Order

Follow phases sequentially:
1. **SETUP** (8 tasks) - Complete all before moving to DATA
2. **DATA** (12 tasks) - Complete all before moving to AUTH
3. **AUTH** (14 tasks) - Complete all before moving to API
4. **API** (28 tasks) - Can parallelize route groups
5. **UI** (21 tasks) - Can parallelize pages
6. **INTEG** (4 tasks) - Final integration testing

### 8.4 Verification Before Completion

Run all 6 verification gates:
```bash
# Gate 1: Endpoint count
bash scripts/verify-endpoint-count.sh

# Gate 2: Page count
bash scripts/verify-page-count.sh

# Gate 3: Forbidden patterns
bash scripts/forbidden-patterns.sh

# Gate 4: Link validation
bash scripts/verify-links.sh

# Gate 5: Route syntax
bash scripts/verify-route-syntax.sh

# Gate 6: HTTP methods
bash scripts/verify-http-methods.sh
```

All gates must pass before marking implementation complete.

### 8.5 Deployment to Replit

```bash
# 1. Configure Replit Secrets
# - DATABASE_URL
# - JWT_SECRET
# - ENCRYPTION_KEY
# - AWS_* credentials

# 2. Build for production
npm run build

# 3. Test production build locally
npm start

# 4. Verify health endpoint
curl https://your-app.replit.app/api/health

# 5. Run database migrations on production
npm run db:migrate

# 6. Monitor logs
# Check Replit console for errors
```

---

## Document Validation

### Completeness Checklist

- [x] All PRD user stories have tasks
- [x] All API endpoints have tasks (43 total)
- [x] All UI pages have tasks (21 total)
- [x] All auth endpoints implemented (8 total, including PATCH /profile)
- [x] All tasks have dependencies specified
- [x] All tasks have acceptance criteria
- [x] All MANDATORY files have full code (6 files)
- [x] Encryption implemented for OAuth tokens
- [x] Optional services use conditional pattern (email)
- [x] Forbidden pattern scan script included (6 patterns)
- [x] Pre-completion verification gates included (6 gates)
- [x] Replit configuration verified (--force flags, watch settings)
- [x] Route paths match API Contract exactly
- [x] HTTP methods match API Contract (PATCH vs PUT verified)
- [x] CSS framework version alignment (Tailwind v4)
- [x] parseIntParam usage mandated (no direct parseInt)
- [x] Response helpers usage mandated (no direct res.json)
- [x] AcceptInvitePage included (commonly missed)

### Task Count Summary

| Category | Count | Notes |
|----------|-------|-------|
| SETUP | 8 | Environment, dependencies, configuration |
| DATA | 12 | Database schema, utilities, mandatory files |
| AUTH | 14 | Authentication routes, middleware, services |
| API | 28 | 43 endpoints across 8 route files |
| UI | 21 | All pages from UI/UX specification |
| INTEG | 4 | Integration testing, deployment verification |
| **TOTAL** | **87** | 94-122 hours estimated |

### Verification

- [x] API task count = API Contract endpoint count (43)
- [x] UI task count = UI/UX page count (21)
- [x] All Replit flags present (--force, usePolling, watch.ignored)
- [x] All OPTIONAL env vars have graceful degradation documented
- [x] Batch insert used for all bulk operations (seed script)
- [x] Validation specs match API Contract exactly
- [x] All route paths have / before parameters
- [x] All HTTP methods cross-referenced with API Contract
- [x] parseIntParam used for all URL parameters
- [x] Response helpers used (sendSuccess, sendCreated, sendPaginated)
- [x] Security-critical code has no TODO comments
- [x] Encryption implemented for sensitive data

### Audit Prevention Summary

This Implementation Plan addresses 21 common production issues identified in Agent 6 specification:
- **CRIT-001**: CSS framework version alignment (Tailwind v4 syntax documented)
- **CRIT-002-005**: Route path syntax validation (verification gate included)
- **CRIT-006-007**: Utility function enforcement (parseIntParam mandated)
- **CRIT-008-009**: Endpoint coverage verification (count gates included)
- **HIGH-001**: Security-critical implementation pattern (full encryption code)
- **HIGH-002**: Third-party API scope definition (Teamwork Desk OAuth specified)
- **HIGH-003-005**: Optional service pattern (email service with graceful degradation)
- **HIGH-006-008**: HTTP method verification (PATCH vs PUT gate included)
- **HIGH-009**: AcceptInvitePage completion (explicitly included in UI phase)
- **MED-002**: UI page tracking (21 pages verified)

### Document Status: COMPLETE

---

## Downstream Agent Handoff Brief

### Agent 7: QA & Deployment

**Pre-Deployment Checklist:**
- [ ] Run all 6 verification gates (see Section 7)
- [ ] Verify all SETUP tasks completed
- [ ] Verify Replit configuration (port 5000, --force flags, watch.ignored)
- [ ] Verify environment variables (REQUIRED crash at startup, OPTIONAL degrade gracefully)
- [ ] Test batch insert performance (seed script)
- [ ] Verify validation compliance (test PASS/FAIL cases from API Contract)
- [ ] Verify route path syntax (all :params have preceding /)
- [ ] Verify HTTP methods match API Contract (PATCH for updates)
- [ ] Verify parseIntParam usage (no direct parseInt in routes)
- [ ] Verify CSS syntax matches Tailwind v4 (@import, not @tailwind)
- [ ] Test AcceptInvitePage flow (/accept-invite route)

**Replit Deployment:**
- Port 5000 configured in .replit
- Database migrations run with --force flag
- Static files served from /dist/public
- Health check responds at /api/health

**Audit Prevention:**
- All 6 forbidden pattern checks PASS
- No TODO in security-critical code
- No direct parseInt in routes
- No malformed route paths
- All sensitive data encrypted
- Optional services implement conditional pattern
- Tailwind v4 syntax verified

---

## ASSUMPTION REGISTER

### AR-IMP-001: Seed Data Sufficient for Development

- **Type:** ASSUMPTION
- **Source Gap:** Data Model provides seed script but doesn't specify if additional test data needed
- **Assumption Made:** Seed script with 1 organization, 3 users, 1 project, 1 data source sufficient for development testing
- **Impact if Wrong:** Developers may need additional test scenarios (multiple projects, large datasets, various data formats)
- **Proposed Resolution:** Monitor developer feedback during implementation. Add supplementary seed data if needed.
- **Status:** UNRESOLVED
- **Owner:** Agent 7 (QA)
- **Date:** 2026-01-21

### AR-IMP-002: compromise.js Accuracy Sufficient for MVP

- **Type:** ASSUMPTION
- **Source Gap:** Architecture specifies compromise.js for PII detection but doesn't provide accuracy benchmarks
- **Assumption Made:** compromise.js + regex patterns achieve 85-90% PII detection accuracy sufficient for MVP
- **Impact if Wrong:** High false negative rate causes privacy violations; high false positive rate reduces dataset quality
- **Proposed Resolution:** Instrument detection accuracy during beta testing (Section 4.3, DATA-012). Add ML model (spaCy, Presidio) post-MVP if accuracy insufficient.
- **Status:** UNRESOLVED
- **Owner:** Agent 7 (QA) → Human (Product) for accuracy threshold decision
- **Date:** 2026-01-21

### AR-IMP-003: Task Time Estimates Assume Single Developer

- **Type:** ASSUMPTION
- **Source Gap:** PRD doesn't specify team size or parallel work capacity
- **Assumption Made:** Task estimates sized for single developer (1-4 hours each). Total 87 tasks = 94-122 hours = 12-15 working days for 1 developer.
- **Impact if Wrong:** With 2+ developers working in parallel (API + UI teams), timeline compresses significantly but requires coordination overhead.
- **Proposed Resolution:** Adjust timeline based on actual team size. API phase (28 tasks) and UI phase (21 tasks) highly parallelizable after AUTH phase completes.
- **Status:** ACCEPTED
- **Owner:** Human (Project Manager)
- **Date:** 2026-01-21

### AR-IMP-004: No Custom Data Source Parsers Needed for MVP

- **Type:** ASSUMPTION
- **Source Gap:** PRD mentions CSV, JSON, XML, XLSX support but doesn't specify parser implementations
- **Assumption Made:** Standard parsing libraries sufficient (csv-parser, xml2js, xlsx npm packages). No custom format handling needed for MVP.
- **Impact if Wrong:** Non-standard CSV dialects (different delimiters, encodings) or malformed files cause parsing failures.
- **Proposed Resolution:** Use robust parsing libraries with error handling. Add custom parsers post-MVP based on user feedback.
- **Status:** ACCEPTED
- **Owner:** Agent 6 (Implementation) - no action needed
- **Date:** 2026-01-21

---

## Prompt Maintenance Contract

If this prompt is edited, you MUST:
1. Update version history in header with changes and `Status: Complete`
2. Re-verify Prompt Hygiene Gate checks (Constitution Section L)
3. Confirm clean encoding (no mojibake/non-ASCII artifacts)
4. Verify no global rule restatements (reference Constitution instead)

Failed checks invalidate prompt update.

### Prompt Hygiene Gate (Constitution Section L)
- [x] Framework Version header present and correct
- [x] Encoding scan: No non-ASCII artifact tokens
- [x] Inheritance references Constitution v3.3
- [x] No full global rule restatements
- [x] All mandatory sections present
- [x] All verification gates included

---

## Document End
